---
phase: 01-foundation-master-data
plan: 01
title: "Project Scaffolding, Database Schema & Connection Pooling"
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - next.config.ts
  - drizzle.config.ts
  - .env.local
  - .env.example
  - src/server/db/schema.ts
  - src/server/db/index.ts
  - src/lib/utils.ts
  - tailwind.config.ts
  - components.json
autonomous: true

must_haves:
  truths:
    - "Next.js 16 project builds and runs with `npm run dev`"
    - "Drizzle schema defines all tables: users, brands, skus, retailers, forecasts, purchase_orders, po_line_items, inventory, payments, audit_log"
    - "Database connection establishes successfully with connection pooling"
    - "drizzle-kit push applies schema to PostgreSQL without errors"
    - "All shadcn/ui base components are installed and importable"
  artifacts:
    - path: "src/server/db/schema.ts"
      provides: "Complete database schema for supply chain"
      contains: "pgTable"
    - path: "src/server/db/index.ts"
      provides: "Database client with connection pooling"
      contains: "Pool"
    - path: "drizzle.config.ts"
      provides: "Drizzle Kit configuration"
      contains: "defineConfig"
  key_links:
    - from: "src/server/db/index.ts"
      to: "src/server/db/schema.ts"
      via: "import * as schema"
      pattern: "import.*schema"
    - from: "drizzle.config.ts"
      to: ".env.local"
      via: "DATABASE_URL environment variable"
      pattern: "DATABASE_URL"
---

# Plan 01-01: Project Scaffolding, Database Schema & Connection Pooling

<objective>
Create the Next.js 16 project from scratch with all dependencies installed, define the complete PostgreSQL database schema using Drizzle ORM covering all entity tables needed for the supply chain system, and establish connection pooling for serverless deployment.

Purpose: This is the foundation everything else builds on. No authentication, no API, no UI can exist without the project scaffold and database schema.
Output: A running Next.js 16 app with complete Drizzle schema and database connection ready for use by subsequent plans.
</objective>

<execution_context>
@/Users/kaaba/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kaaba/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-master-data/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Next.js 16 project and install all dependencies</name>
  <files>
    package.json
    tsconfig.json
    next.config.ts
    tailwind.config.ts
    components.json
    src/app/layout.tsx
    src/app/page.tsx
    src/lib/utils.ts
    .env.local
    .env.example
    .gitignore
  </files>
  <action>
  **Step 1: Create Next.js project.**
  Run from the project root `/Users/kaaba/petra-supply-hub`:
  ```bash
  npx create-next-app@latest . --typescript --tailwind --app --src-dir --import-alias "@/*"
  ```
  Accept defaults. If it asks about Turbopack, say yes. If it asks about ESLint, say yes.

  **Step 2: Install core dependencies.**
  ```bash
  npm install drizzle-orm pg @auth/core @auth/drizzle-adapter next-auth@beta
  npm install @trpc/server @trpc/client @trpc/react-query @trpc/next
  npm install @tanstack/react-query zod server-only client-only bcryptjs
  npm install -D drizzle-kit @types/pg @types/bcryptjs
  ```

  **Step 3: Initialize shadcn/ui.**
  ```bash
  npx shadcn@latest init -d
  ```
  This should auto-detect Next.js, Tailwind, and TypeScript.

  **Step 4: Add shadcn components needed for Phase 1.**
  ```bash
  npx shadcn@latest add button card input label table dialog dropdown-menu sidebar avatar badge separator sheet tabs toast sonner
  ```

  **Step 5: Create environment files.**

  Create `.env.local` with:
  ```
  # Database
  DATABASE_URL=postgresql://postgres:postgres@localhost:5432/petra_supply_hub

  # Auth.js
  AUTH_SECRET=generate-a-random-secret-at-least-32-chars-long
  AUTH_URL=http://localhost:3000

  # App
  NEXT_PUBLIC_APP_NAME="Petra Supply Hub"
  ```

  Create `.env.example` with the same keys but placeholder values (no real secrets):
  ```
  DATABASE_URL=postgresql://user:password@host:5432/petra_supply_hub
  AUTH_SECRET=your-secret-here
  AUTH_URL=http://localhost:3000
  NEXT_PUBLIC_APP_NAME="Petra Supply Hub"
  ```

  **Step 6: Update .gitignore** to include `.env.local` (should already be there from create-next-app, but verify).

  **Step 7: Verify the project builds.**
  ```bash
  npm run build
  ```
  Must complete without errors.
  </action>
  <verify>
  - `npm run build` succeeds with exit code 0
  - `ls node_modules/drizzle-orm` confirms Drizzle installed
  - `ls node_modules/next-auth` confirms Auth.js installed
  - `ls node_modules/@trpc/server` confirms tRPC installed
  - `ls src/components/ui/button.tsx` confirms shadcn components installed
  - `.env.local` exists with DATABASE_URL
  </verify>
  <done>
  Next.js 16 project created at /Users/kaaba/petra-supply-hub with all dependencies installed (Drizzle ORM, Auth.js v5, tRPC v11, shadcn/ui, TanStack Query, Zod, bcryptjs). Project builds successfully. Environment files configured.
  </done>
</task>

<task type="auto">
  <name>Task 2: Define complete database schema with Drizzle ORM</name>
  <files>
    src/server/db/schema.ts
    src/server/db/index.ts
    drizzle.config.ts
  </files>
  <action>
  **Create `src/server/db/schema.ts`** with the complete supply chain schema.

  IMPORTANT: Use `pgTable` from `drizzle-orm/pg-core`. Include `relations` from `drizzle-orm`. Add indexes on all foreign keys and frequently queried columns.

  **Tables to define (with exact columns):**

  **1. users** (for Auth.js + role-based access)
  - `id` — text, primaryKey (Auth.js uses text IDs by default with DrizzleAdapter)
  - `name` — varchar(255), notNull
  - `email` — varchar(255), notNull, unique
  - `emailVerified` — timestamp (Auth.js requirement)
  - `image` — text (Auth.js requirement)
  - `passwordHash` — text, notNull (for Credentials provider)
  - `role` — varchar(50), notNull, default 'viewer' (values: 'ceo', 'sales', 'purchasing', 'warehouse', 'admin')
  - `active` — boolean, default true, notNull
  - `createdAt` — timestamp, defaultNow, notNull
  - `updatedAt` — timestamp, defaultNow, notNull

  **2. accounts** (Auth.js adapter requirement)
  - `userId` — text, notNull, references users.id onDelete cascade
  - `type` — varchar(255), notNull
  - `provider` — varchar(255), notNull
  - `providerAccountId` — varchar(255), notNull
  - `refresh_token` — text
  - `access_token` — text
  - `expires_at` — integer
  - `token_type` — varchar(255)
  - `scope` — varchar(255)
  - `id_token` — text
  - `session_state` — varchar(255)
  - Primary key: composite(provider, providerAccountId)

  **3. sessions** (Auth.js adapter requirement)
  - `sessionToken` — varchar(255), primaryKey
  - `userId` — text, notNull, references users.id onDelete cascade
  - `expires` — timestamp, notNull

  **4. brands** (master data — FND-03)
  - `id` — serial, primaryKey
  - `name` — varchar(255), notNull, unique
  - `description` — text
  - `leadTimeDays` — integer, notNull, default 30 (30 for most brands, 60 for HOP)
  - `active` — boolean, default true, notNull
  - `createdAt` — timestamp, defaultNow, notNull
  - `updatedAt` — timestamp, defaultNow, notNull

  **5. skus** (master data — FND-03)
  - `id` — serial, primaryKey
  - `brandId` — integer, notNull, references brands.id
  - `sku` — varchar(100), notNull, unique
  - `name` — varchar(255), notNull
  - `description` — text
  - `category` — varchar(100) (e.g., "clean towels", "mosquito repellent", "craft kits")
  - `unitCost` — numeric(10,2) (cost from China supplier in USD)
  - `unitPrice` — numeric(10,2) (selling price to retailer)
  - `active` — boolean, default true, notNull
  - `createdAt` — timestamp, defaultNow, notNull
  - `updatedAt` — timestamp, defaultNow, notNull
  - Index on: brandId, sku

  **6. retailers** (master data — FND-03)
  - `id` — serial, primaryKey
  - `name` — varchar(255), notNull, unique
  - `code` — varchar(50), notNull, unique (short code like "TJX_MARMAXX", "FIVE_BELOW")
  - `parentGroup` — varchar(255) (e.g., "TJX Companies" for MarMaxx, HomeGoods, Sierra)
  - `channel` — varchar(100) (e.g., "off-price", "grocery", "mass", "online")
  - `active` — boolean, default true, notNull
  - `createdAt` — timestamp, defaultNow, notNull
  - `updatedAt` — timestamp, defaultNow, notNull

  **7. brand_retailers** (many-to-many: which brands sell at which retailers)
  - `id` — serial, primaryKey
  - `brandId` — integer, notNull, references brands.id
  - `retailerId` — integer, notNull, references retailers.id
  - `active` — boolean, default true, notNull
  - `createdAt` — timestamp, defaultNow, notNull
  - Unique constraint on: (brandId, retailerId)

  **8. forecasts** (demand planning — used in Phase 2+)
  - `id` — serial, primaryKey
  - `skuId` — integer, notNull, references skus.id
  - `retailerId` — integer, notNull, references retailers.id
  - `month` — date, notNull (first day of month, e.g., 2026-01-01 for January)
  - `forecastedUnits` — integer, notNull, default 0
  - `orderedUnits` — integer, default 0
  - `source` — varchar(50), default 'manual' (values: 'manual', 'excel_import', 'api_sync')
  - `notes` — text
  - `createdBy` — text, references users.id
  - `createdAt` — timestamp, defaultNow, notNull
  - `updatedAt` — timestamp, defaultNow, notNull
  - Index on: skuId, retailerId, month
  - Unique constraint on: (skuId, retailerId, month)

  **9. purchase_orders** (supplier POs to China — used in Phase 2+)
  - `id` — serial, primaryKey
  - `poNumber` — varchar(100), notNull, unique
  - `brandId` — integer, notNull, references brands.id
  - `supplier` — varchar(255) (factory name in China)
  - `status` — varchar(50), notNull, default 'draft' (values: 'draft', 'submitted', 'deposit_paid', 'in_production', 'shipped', 'in_transit', 'arrived', 'allocated', 'cancelled')
  - `orderDate` — date
  - `expectedArrival` — date
  - `actualArrival` — date
  - `totalAmount` — numeric(12,2)
  - `currency` — varchar(10), default 'USD'
  - `depositAmount` — numeric(12,2)
  - `depositPaid` — boolean, default false
  - `notes` — text
  - `createdBy` — text, references users.id
  - `createdAt` — timestamp, defaultNow, notNull
  - `updatedAt` — timestamp, defaultNow, notNull
  - Index on: brandId, status, poNumber

  **10. po_line_items** (individual SKUs within a PO)
  - `id` — serial, primaryKey
  - `purchaseOrderId` — integer, notNull, references purchase_orders.id onDelete cascade
  - `skuId` — integer, notNull, references skus.id
  - `quantity` — integer, notNull
  - `unitCost` — numeric(10,2)
  - `totalCost` — numeric(12,2)
  - `createdAt` — timestamp, defaultNow, notNull
  - Index on: purchaseOrderId, skuId

  **11. inventory** (warehouse stock levels — used in Phase 2+)
  - `id` — serial, primaryKey
  - `skuId` — integer, notNull, references skus.id
  - `quantityOnHand` — integer, notNull, default 0
  - `quantityAllocated` — integer, default 0 (committed to retailer POs)
  - `quantityInTransit` — integer, default 0 (on the way from China)
  - `quantityAvailable` — integer generated always as (quantityOnHand - quantityAllocated) stored — OR compute this in application code. Use application-level computation: `available = onHand - allocated`.
  - `lastUpdated` — timestamp, defaultNow, notNull
  - `source` — varchar(50), default 'manual' (values: 'manual', 'sellercloud', 'adjustment')
  - `notes` — text
  - `updatedBy` — text, references users.id
  - Unique constraint on: skuId (one inventory record per SKU)
  - Index on: skuId

  NOTE: Do NOT use a generated column for quantityAvailable. Drizzle ORM does not cleanly support PostgreSQL generated columns. Instead, compute available = onHand - allocated in application code or with a view.

  **12. retail_orders** (incoming POs FROM retailers — used in Phase 4)
  - `id` — serial, primaryKey
  - `retailerId` — integer, notNull, references retailers.id
  - `retailerPoNumber` — varchar(100)
  - `brandId` — integer, notNull, references brands.id
  - `status` — varchar(50), notNull, default 'received' (values: 'received', 'processing', 'shipped', 'delivered', 'cancelled')
  - `orderDate` — date
  - `shipByDate` — date
  - `totalAmount` — numeric(12,2)
  - `notes` — text
  - `createdBy` — text, references users.id
  - `createdAt` — timestamp, defaultNow, notNull
  - `updatedAt` — timestamp, defaultNow, notNull
  - Index on: retailerId, brandId, status

  **13. retail_order_line_items** (individual SKUs within a retail order)
  - `id` — serial, primaryKey
  - `retailOrderId` — integer, notNull, references retail_orders.id onDelete cascade
  - `skuId` — integer, notNull, references skus.id
  - `quantity` — integer, notNull
  - `unitPrice` — numeric(10,2)
  - `totalPrice` — numeric(12,2)
  - `createdAt` — timestamp, defaultNow, notNull
  - Index on: retailOrderId, skuId

  **14. payments** (cash flow tracking — used in later phases)
  - `id` — serial, primaryKey
  - `purchaseOrderId` — integer, references purchase_orders.id
  - `retailOrderId` — integer, references retail_orders.id
  - `type` — varchar(50), notNull (values: 'deposit', 'pre_shipment', 'shipment', 'retailer_payment')
  - `amount` — numeric(12,2), notNull
  - `currency` — varchar(10), default 'USD'
  - `status` — varchar(50), notNull, default 'pending' (values: 'pending', 'paid', 'overdue', 'cancelled')
  - `dueDate` — date
  - `paidDate` — date
  - `notes` — text
  - `createdBy` — text, references users.id
  - `createdAt` — timestamp, defaultNow, notNull
  - `updatedAt` — timestamp, defaultNow, notNull
  - Index on: purchaseOrderId, retailOrderId, status

  **15. audit_log** (FND-04)
  - `id` — serial, primaryKey
  - `tableName` — varchar(100), notNull
  - `recordId` — text, notNull (text to handle both serial int and text IDs)
  - `action` — varchar(20), notNull (values: 'INSERT', 'UPDATE', 'DELETE')
  - `userId` — text (can be null for system-triggered changes)
  - `changedData` — text (JSON string of new values)
  - `previousData` — text (JSON string of old values)
  - `createdAt` — timestamp, defaultNow, notNull
  - Index on: tableName, recordId, createdAt

  **Define all Drizzle relations:**
  - brands -> skus (one-to-many)
  - brands -> purchase_orders (one-to-many)
  - brands -> brand_retailers (one-to-many)
  - skus -> forecasts (one-to-many)
  - skus -> po_line_items (one-to-many)
  - skus -> inventory (one-to-one)
  - retailers -> forecasts (one-to-many)
  - retailers -> brand_retailers (one-to-many)
  - retailers -> retail_orders (one-to-many)
  - purchase_orders -> po_line_items (one-to-many)
  - purchase_orders -> payments (one-to-many)
  - retail_orders -> retail_order_line_items (one-to-many)
  - retail_orders -> payments (one-to-many)
  - users -> sessions (one-to-many)
  - users -> accounts (one-to-many)

  **Create `src/server/db/index.ts`** with connection pooling:
  ```typescript
  import { drizzle } from 'drizzle-orm/node-postgres';
  import { Pool } from 'pg';
  import * as schema from './schema';

  const globalForPool = globalThis as unknown as {
    pool: Pool | undefined;
  };

  export const pool = globalForPool.pool ?? new Pool({
    connectionString: process.env.DATABASE_URL!,
    max: 1,
    idleTimeoutMillis: 5000,
    connectionTimeoutMillis: 10000,
  });

  if (process.env.NODE_ENV !== 'production') globalForPool.pool = pool;

  export const db = drizzle(pool, { schema });
  ```

  **Create `drizzle.config.ts`:**
  ```typescript
  import { defineConfig } from 'drizzle-kit';

  export default defineConfig({
    schema: './src/server/db/schema.ts',
    out: './drizzle/migrations',
    dialect: 'postgresql',
    dbCredentials: {
      url: process.env.DATABASE_URL!,
    },
  });
  ```

  **Add npm scripts to package.json:**
  ```json
  "db:push": "drizzle-kit push",
  "db:generate": "drizzle-kit generate",
  "db:migrate": "drizzle-kit migrate",
  "db:studio": "drizzle-kit studio",
  "db:seed": "tsx src/server/db/seed.ts"
  ```

  IMPORTANT: TypeScript must compile without errors. All imports must resolve. All foreign key references must point to existing table definitions. Use `numeric` from `drizzle-orm/pg-core` for money fields (NOT `real` or `float`).
  </action>
  <verify>
  - `npx tsc --noEmit` passes (or `npm run build` succeeds) — no TypeScript errors in schema
  - Schema file exports all 15 tables (users, accounts, sessions, brands, skus, retailers, brand_retailers, forecasts, purchase_orders, po_line_items, inventory, retail_orders, retail_order_line_items, payments, audit_log)
  - All relation definitions compile without errors
  - `npx drizzle-kit push` succeeds when DATABASE_URL points to a running PostgreSQL instance (test locally or note in verification that DB must be running)
  - drizzle.config.ts points to correct schema path
  </verify>
  <done>
  Complete Drizzle ORM schema defines 15 tables covering: Auth.js requirements (users, accounts, sessions), master data (brands, skus, retailers, brand_retailers), supply chain operations (forecasts, purchase_orders, po_line_items, inventory, retail_orders, retail_order_line_items, payments), and audit trail (audit_log). All relations defined. Connection pooling configured with global singleton for serverless. Drizzle Kit configured for migrations. FND-01 (database schema) is fully addressed.
  </done>
</task>

</tasks>

<verification>
- [ ] `npm run dev` starts the Next.js dev server on localhost:3000
- [ ] `npm run build` completes without errors
- [ ] `npx tsc --noEmit` passes with no type errors
- [ ] All 15 tables defined in schema.ts with proper types and relations
- [ ] Foreign keys reference correct tables
- [ ] Indexes defined on all foreign key columns and frequently queried fields
- [ ] Connection pooling uses global singleton pattern with max:1
- [ ] `.env.local` exists with DATABASE_URL
- [ ] `.env.example` exists without real secrets
- [ ] shadcn/ui components installed in src/components/ui/
</verification>

<success_criteria>
- Next.js 16 project is fully scaffolded with all Phase 1 dependencies
- Database schema covers all entities needed for FND-01 (5 brands, 160 SKUs, 12 retailers, forecasts, POs, inventory, payments)
- Schema includes audit_log table for FND-04
- Connection pooling is configured for serverless deployment
- Project compiles and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-master-data/01-01-SUMMARY.md`
</output>
