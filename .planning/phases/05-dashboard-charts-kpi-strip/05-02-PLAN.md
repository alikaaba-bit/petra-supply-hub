---
phase: 05-dashboard-charts-kpi-strip
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/dashboard/revenue-trend-chart.tsx
  - src/components/dashboard/brand-performance-chart.tsx
  - src/components/dashboard/retailer-mix-chart.tsx
  - src/components/dashboard/kpi-strip.tsx
  - src/app/(dashboard)/executive/page.tsx
autonomous: false

must_haves:
  truths:
    - "User sees a top strip on the executive dashboard showing Revenue MTD, Units Shipped MTD, Open Alerts count, and Active POs count updating from real data"
    - "User can view a revenue trend line chart showing the last 6-12 months with brands stacked, and hover to see per-brand values"
    - "User can view a brand performance bar chart comparing revenue across all five brands"
    - "User can view a retailer revenue mix chart with brand breakdown showing which retailers drive the most revenue"
  artifacts:
    - path: "src/components/dashboard/kpi-strip.tsx"
      provides: "KPI strip with 4 metric cards"
      contains: "Revenue MTD"
    - path: "src/components/dashboard/revenue-trend-chart.tsx"
      provides: "Stacked area chart for revenue over time by brand"
      contains: "AreaChart"
    - path: "src/components/dashboard/brand-performance-chart.tsx"
      provides: "Bar chart comparing brand revenues"
      contains: "BarChart"
    - path: "src/components/dashboard/retailer-mix-chart.tsx"
      provides: "Horizontal stacked bar chart for retailer revenue with brand breakdown"
      contains: "BarChart"
    - path: "src/app/(dashboard)/executive/page.tsx"
      provides: "Updated executive page integrating all charts and KPI strip"
      contains: "KpiStrip"
  key_links:
    - from: "src/components/dashboard/kpi-strip.tsx"
      to: "trpc.dashboard.kpiSummary"
      via: "tRPC useQuery hook"
      pattern: "trpc\\.dashboard\\.kpiSummary"
    - from: "src/components/dashboard/revenue-trend-chart.tsx"
      to: "ChartContainer"
      via: "shadcn/ui chart wrapper"
      pattern: "ChartContainer"
    - from: "src/app/(dashboard)/executive/page.tsx"
      to: "trpc.dashboard"
      via: "tRPC useQuery hooks for all 4 endpoints"
      pattern: "trpc\\.dashboard\\."
---

<objective>
Build all 4 chart/KPI UI components and integrate them into the executive dashboard page, completing VIZ-01 through VIZ-04.

Purpose: Transform the executive summary from a text-based overview into a visual command center with interactive charts and real-time KPI indicators.
Output: 4 new chart/KPI components rendered on the executive page, all fetching real data via the dashboardRouter endpoints from Plan 01.
</objective>

<execution_context>
@/Users/kaaba/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kaaba/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-dashboard-charts-kpi-strip/05-RESEARCH.md
@.planning/phases/05-dashboard-charts-kpi-strip/05-01-SUMMARY.md

Key existing files:
@src/components/dashboard/stat-card.tsx — Existing StatCard component (reuse for KPI strip)
@src/app/(dashboard)/executive/page.tsx — Current executive page (modify to add charts)
@src/components/ui/chart.tsx — shadcn/ui chart component (from Plan 01)
@src/server/api/routers/dashboard.ts — Dashboard router endpoints (from Plan 01)
@src/lib/trpc.ts — tRPC client hook
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build KPI strip and revenue trend chart components</name>
  <files>src/components/dashboard/kpi-strip.tsx, src/components/dashboard/revenue-trend-chart.tsx</files>
  <action>
    **KPI Strip — `src/components/dashboard/kpi-strip.tsx`** (VIZ-04)

    Create a "use client" component that:
    - Calls `trpc.dashboard.kpiSummary.useQuery()` to fetch KPI data
    - Renders a responsive 4-column grid (`grid gap-4 md:grid-cols-2 lg:grid-cols-4`)
    - Uses the existing `StatCard` component from `@/components/dashboard/stat-card`
    - 4 cards with icons from lucide-react:
      1. "Revenue MTD" — DollarSign icon — format as `$XX,XXX` using `toLocaleString("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 0 })`
      2. "Units Shipped MTD" — Package icon — format with `toLocaleString()`
      3. "Open Alerts" — AlertTriangle icon — raw number
      4. "Active POs" — ShoppingCart icon — raw number
    - Pass `loading={!kpis}` to each StatCard for skeleton state
    - Add label beneath the section header: "(Feb MTD)" or similar using `format(new Date(), "MMM yyyy")` to clarify the time period

    **Revenue Trend Chart — `src/components/dashboard/revenue-trend-chart.tsx`** (VIZ-01)

    Create a "use client" component that:
    - Accepts `data` prop (the wide-format array from revenueTrend endpoint)
    - Accepts optional `isLoading` boolean prop for loading state
    - Uses shadcn/ui ChartContainer, ChartTooltip, ChartTooltipContent from `@/components/ui/chart`
    - Uses Recharts AreaChart with stacked areas (one Area per brand with `stackId="revenue"`)
    - Brand names and colors defined in chartConfig using `satisfies ChartConfig`:
      - "Fomin": hsl(var(--chart-1))
      - "Luna Naturals": hsl(var(--chart-2))
      - "EveryMood": hsl(var(--chart-3))
      - "Roofus": hsl(var(--chart-4))
      - "House of Party": hsl(var(--chart-5))
    - Renders inside a Card with CardHeader (title: "Revenue Trend", description: "Last 12 months by brand") and CardContent
    - XAxis: dataKey="month", YAxis: tickFormatter formats as "$Xk" (divide by 1000)
    - CartesianGrid with strokeDasharray="3 3"
    - ChartTooltip with ChartTooltipContent for hover details
    - ChartContainer className="min-h-[350px] w-full"
    - Map over Object.keys(chartConfig) to render Area elements dynamically (not hardcoded 5 times)
    - Each Area: type="monotone", fillOpacity={0.4}, stroke and fill from chartConfig
    - If isLoading, show a skeleton div instead of the chart
    - If data is empty, show "No revenue data available" centered text

    Import AreaChart, Area, CartesianGrid, XAxis, YAxis from "recharts" (NOT from the chart.tsx wrapper).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `grep "ChartContainer" src/components/dashboard/revenue-trend-chart.tsx` confirms shadcn/ui usage
    - `grep "StatCard" src/components/dashboard/kpi-strip.tsx` confirms reuse of existing component
    - `grep "stackId" src/components/dashboard/revenue-trend-chart.tsx` confirms stacked area
  </verify>
  <done>KPI strip renders 4 metric cards from real data, revenue trend chart renders stacked area with 5 brand series. Both components compile without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Build brand performance and retailer mix chart components</name>
  <files>src/components/dashboard/brand-performance-chart.tsx, src/components/dashboard/retailer-mix-chart.tsx</files>
  <action>
    **Brand Performance Chart — `src/components/dashboard/brand-performance-chart.tsx`** (VIZ-02)

    Create a "use client" component that:
    - Accepts `data` prop: `{ brandName: string, revenue: number }[]`
    - Accepts optional `isLoading` boolean prop
    - Renders inside a Card with CardHeader (title: "Brand Performance", description: "Total revenue by brand")
    - Uses ChartContainer from shadcn/ui with chartConfig:
      - Each brand as a key with its color (same 5 colors as revenue trend)
    - Uses Recharts BarChart (vertical bars) with a single Bar component
    - XAxis: dataKey="brandName", YAxis: tickFormatter as "$Xk"
    - CartesianGrid, ChartTooltip with ChartTooltipContent
    - ChartContainer className="min-h-[300px] w-full"
    - For individual bar colors per brand, use the Recharts `Cell` pattern — BUT research says Cell is deprecated in v3.7.0. Instead, use a simpler approach: use a single `revenue` key in chartConfig with one color `hsl(var(--chart-1))`, and render as a simple single-series bar chart. This is cleaner and avoids the deprecated API.
    - Actually, for per-brand colors, define chartConfig with a `revenue` key (single color). The bar chart compares brands on the X axis, so one color is appropriate (each bar IS a different brand already labeled on the axis). This matches the shadcn/ui bar chart example.
    - If isLoading, show skeleton. If data empty, show "No brand data available".

    **Retailer Mix Chart — `src/components/dashboard/retailer-mix-chart.tsx`** (VIZ-03)

    Create a "use client" component that:
    - Accepts `data` prop: the wide-format array from retailerMix endpoint `{ retailerName: string, Fomin: number, "Luna Naturals": number, ... }[]`
    - Accepts optional `isLoading` boolean prop
    - Renders inside a Card with CardHeader (title: "Retailer Revenue Mix", description: "Revenue by retailer with brand breakdown")
    - Uses a HORIZONTAL stacked bar chart: `<BarChart data={data} layout="horizontal">`
    - Actually, for horizontal bars in Recharts, you swap XAxis/YAxis: use `<BarChart data={data} layout="vertical">` with `<XAxis type="number">` and `<YAxis type="category" dataKey="retailerName" width={120}>`
    - One Bar per brand, each with `stackId="revenue"` for stacking
    - Use same brand chartConfig as revenue trend chart (5 brands, 5 colors)
    - Map over brand names to create Bar elements dynamically
    - CartesianGrid, ChartTooltip with ChartTooltipContent
    - ChartContainer className="min-h-[400px] w-full" (taller because vertical layout with many retailers)
    - If isLoading, show skeleton. If data empty, show "No retailer data available".

    Brand names constant: Extract a shared `BRAND_NAMES` array used by both charts: `["Fomin", "Luna Naturals", "EveryMood", "Roofus", "House of Party"]`. Define it locally in each file (simpler than a shared module for 2 files). Use the same chartConfig object shape in both files.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `grep "BarChart" src/components/dashboard/brand-performance-chart.tsx` confirms bar chart usage
    - `grep 'layout="vertical"' src/components/dashboard/retailer-mix-chart.tsx` confirms horizontal bar layout
    - `grep "stackId" src/components/dashboard/retailer-mix-chart.tsx` confirms stacked bars
  </verify>
  <done>Brand performance bar chart renders with revenue comparison across 5 brands. Retailer mix chart renders horizontal stacked bars showing brand breakdown per retailer. Both compile without errors.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate all components into executive dashboard page</name>
  <files>src/app/(dashboard)/executive/page.tsx</files>
  <action>
    Update the existing executive page (`src/app/(dashboard)/executive/page.tsx`) to integrate all 4 new components while preserving all existing content.

    **Layout structure (top to bottom):**
    1. Header (existing — keep as is)
    2. **NEW: KPI Strip** — `<KpiStrip />` (self-contained, fetches its own data)
    3. **NEW: Revenue Trend Chart** — full width, fetches data in page
    4. **NEW: Two-column grid** for Brand Performance + Retailer Mix charts
    5. Key Numbers section (existing — keep as is, but consider if it overlaps with KPI strip)
    6. Alert Summary (existing — keep as is)
    7. Monthly Trend (existing — keep as is)
    8. Action Items (existing — keep as is)

    **Data fetching changes:**
    Add 3 new tRPC queries at the top of the component:
    ```
    const { data: revenueTrend, isLoading: revenueLoading } = trpc.dashboard.revenueTrend.useQuery({ months: 12 });
    const { data: brandPerformance, isLoading: brandLoading } = trpc.dashboard.brandPerformance.useQuery();
    const { data: retailerMix, isLoading: retailerLoading } = trpc.dashboard.retailerMix.useQuery();
    ```

    KpiStrip fetches its own data internally (self-contained component), so no additional query needed for it.

    **Import the new components:**
    ```
    import { KpiStrip } from "@/components/dashboard/kpi-strip";
    import { RevenueTrendChart } from "@/components/dashboard/revenue-trend-chart";
    import { BrandPerformanceChart } from "@/components/dashboard/brand-performance-chart";
    import { RetailerMixChart } from "@/components/dashboard/retailer-mix-chart";
    ```

    **Section layout:**
    After the header div, add:
    - `<KpiStrip />` with no wrapper needed
    - `<RevenueTrendChart data={revenueTrend ?? []} isLoading={revenueLoading} />`
    - A `<div className="grid gap-6 lg:grid-cols-2">` containing:
      - `<BrandPerformanceChart data={brandPerformance ?? []} isLoading={brandLoading} />`
      - `<RetailerMixChart data={retailerMix ?? []} isLoading={retailerLoading} />`

    **Regarding the existing "Key Numbers" section:**
    The existing Key Numbers section shows Total Brands, Total SKUs, Active POs, Active Retail Orders. The new KPI strip shows Revenue MTD, Units Shipped MTD, Open Alerts, Active POs. There is minor overlap (Active POs appears in both). Keep both sections — the Key Numbers provides inventory/catalog context while the KPI strip provides financial/operational context. They serve different purposes.

    Preserve all existing imports and queries. Only ADD new ones.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `grep "KpiStrip\|RevenueTrendChart\|BrandPerformanceChart\|RetailerMixChart" src/app/\(dashboard\)/executive/page.tsx` shows all 4 imports
    - `grep "trpc.dashboard" src/app/\(dashboard\)/executive/page.tsx` shows dashboard queries
    - `pnpm build` completes without errors (full Next.js build verification)
  </verify>
  <done>Executive dashboard page renders KPI strip at top, revenue trend chart, brand performance and retailer mix charts in two-column grid, followed by all existing content. Page builds and loads without errors.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete dashboard visualization suite: KPI strip with 4 metrics, stacked area revenue trend chart, brand performance bar chart, and retailer revenue mix horizontal stacked bar chart — all integrated into the executive summary page with real data from PostgreSQL.</what-built>
  <how-to-verify>
    1. Start dev server: `pnpm dev`
    2. Navigate to http://localhost:3000/executive (login as CEO if prompted)
    3. Verify KPI Strip at top shows 4 cards: Revenue MTD, Units Shipped MTD, Open Alerts, Active POs
    4. Verify Revenue Trend chart shows stacked area chart with brand colors and month labels on X axis
    5. Hover over the revenue trend chart — tooltip should show per-brand values
    6. Verify Brand Performance bar chart shows 5 brands with revenue bars
    7. Verify Retailer Mix chart shows horizontal stacked bars with brand color breakdown per retailer
    8. Scroll down — existing Key Numbers, Alert Summary, Monthly Trend, and Action Items sections still visible
    9. Resize browser to test responsive layout (charts should stack on mobile, grid on desktop)
  </how-to-verify>
  <resume-signal>Type "approved" if all 4 visualizations render correctly, or describe any visual/functional issues</resume-signal>
</task>

</tasks>

<verification>
1. `pnpm build` — full Next.js build passes
2. All 4 chart/KPI components exist in src/components/dashboard/
3. Executive page imports and renders all 4 components
4. Charts use shadcn/ui ChartContainer (not raw Recharts containers)
5. KPI strip shows real aggregated data from database
6. Revenue trend shows stacked areas with brand colors
7. Brand performance shows comparative bars
8. Retailer mix shows horizontal stacked bars with brand breakdown
</verification>

<success_criteria>
- KPI strip displays Revenue MTD, Units Shipped MTD, Open Alerts, Active POs from real data
- Revenue trend chart renders stacked area chart with 5 brands over 12 months, hover shows per-brand tooltip
- Brand performance chart renders bar chart comparing revenue across 5 brands
- Retailer mix chart renders horizontal stacked bar chart with brand breakdown per retailer
- All charts use shadcn/ui theming (CSS variables, ChartContainer)
- Executive page loads without errors, existing content preserved
- Responsive layout: charts stack on mobile, grid on desktop
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard-charts-kpi-strip/05-02-SUMMARY.md`
</output>
