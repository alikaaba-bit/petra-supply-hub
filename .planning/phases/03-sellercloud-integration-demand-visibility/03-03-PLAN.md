---
phase: 03-sellercloud-integration-demand-visibility
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/app/(dashboard)/demand/page.tsx
  - src/app/(dashboard)/demand/by-retailer/page.tsx
  - src/app/(dashboard)/demand/by-sku/page.tsx
  - src/components/demand/brand-selector.tsx
  - src/components/demand/shortage-alerts.tsx
  - src/components/demand/excess-alerts.tsx
  - src/components/demand/demand-summary-card.tsx
autonomous: true

must_haves:
  truths:
    - "Cross-brand demand summary page shows forecasted vs ordered vs in-stock per brand per month"
    - "Retailer breakdown page displays what each retailer needs across brands"
    - "SKU drill-down page shows demand, ordered, available, in-transit, and balance per SKU"
    - "Shortage alerts visually flag SKUs with red badges showing units short"
    - "Excess alerts visually flag SKUs with amber badges showing excess units"
    - "Brand selector allows filtering all views to a single brand or all brands"
  artifacts:
    - path: "src/app/(dashboard)/demand/page.tsx"
      provides: "Cross-brand demand summary with data table and shortage/excess alert panels"
      min_lines: 80
    - path: "src/app/(dashboard)/demand/by-retailer/page.tsx"
      provides: "Retailer-level demand breakdown table"
      min_lines: 50
    - path: "src/app/(dashboard)/demand/by-sku/page.tsx"
      provides: "SKU-level drill-down table with shortage/excess columns"
      min_lines: 80
    - path: "src/components/demand/brand-selector.tsx"
      provides: "Dropdown to filter by brand or view all brands"
      min_lines: 20
  key_links:
    - from: "src/app/(dashboard)/demand/page.tsx"
      to: "demand.crossBrandSummary"
      via: "trpc.demand.crossBrandSummary.useQuery()"
      pattern: "trpc\\.demand\\.crossBrandSummary"
    - from: "src/app/(dashboard)/demand/by-retailer/page.tsx"
      to: "demand.retailerBreakdown"
      via: "trpc.demand.retailerBreakdown.useQuery()"
      pattern: "trpc\\.demand\\.retailerBreakdown"
    - from: "src/app/(dashboard)/demand/by-sku/page.tsx"
      to: "demand.skuDrillDown"
      via: "trpc.demand.skuDrillDown.useQuery()"
      pattern: "trpc\\.demand\\.skuDrillDown"
    - from: "src/app/(dashboard)/demand/page.tsx"
      to: "alerts.shortages|alerts.excesses"
      via: "trpc.alerts.shortages.useQuery()"
      pattern: "trpc\\.alerts\\.(shortages|excesses)"
---

<objective>
Build the demand visibility dashboard pages: cross-brand summary, retailer breakdown, and SKU drill-down views with brand selector filtering, shortage/excess alert panels, and visual indicators.

Purpose: Delivers the core demand visibility features (DEM-01 through DEM-05, UX-01) that let the team see gaps between forecasted demand and available supply across all brands and retailers.
Output: 3 new dashboard pages under /demand/, reusable brand selector component, shortage and excess alert components.
</objective>

<execution_context>
@/Users/kaaba/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kaaba/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-sellercloud-integration-demand-visibility/03-RESEARCH.md
@.planning/phases/03-sellercloud-integration-demand-visibility/03-02-SUMMARY.md
@src/app/(dashboard)/page.tsx
@src/components/dashboard/app-sidebar.tsx
@src/lib/trpc.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Brand selector and alert components</name>
  <files>
    src/components/demand/brand-selector.tsx
    src/components/demand/shortage-alerts.tsx
    src/components/demand/excess-alerts.tsx
    src/components/demand/demand-summary-card.tsx
  </files>
  <action>
Install shadcn alert component if not already present: `npx shadcn@latest add alert` (badge already installed per ui/ listing).

Create `src/components/demand/brand-selector.tsx`:
- "use client" component
- Props: `{ selectedBrandId: number | undefined, onBrandChange: (brandId: number | undefined) => void }`
- Uses `trpc.brands.list.useQuery()` to fetch all brands
- Renders a shadcn Select component with options: "All Brands" (value undefined) + one option per brand
- Compact inline style for embedding in page headers

Create `src/components/demand/demand-summary-card.tsx`:
- Props: `{ title: string, forecastedUnits: number, orderedUnits: number, availableUnits: number, balance: number }`
- Uses shadcn Card component
- Shows 4 stats in a compact layout: Forecasted, Ordered, Available, Balance
- Balance shows green text if positive (surplus), red text if negative (deficit)
- Format numbers with toLocaleString() for readability

Create `src/components/demand/shortage-alerts.tsx`:
- "use client" component
- Props: `{ alerts: { sku: string, skuName: string, brandName: string, shortage: number, forecastedUnits: number, availableUnits: number }[] }`
- If alerts empty: show a green Alert with "No Shortages" message
- If alerts present: show list (max 10) using shadcn Alert variant="destructive"
- Each alert shows: SKU code, SKU name, brand, shortage Badge variant="destructive" with "{N} units short"
- Shows forecasted vs available for context

Create `src/components/demand/excess-alerts.tsx`:
- "use client" component
- Props: `{ alerts: { sku: string, skuName: string, brandName: string, excess: number, forecastedUnits: number, supply: number, ratio: number }[] }`
- Similar pattern to shortage alerts but with amber/warning styling
- Badge shows "{N} excess units"
- Shows supply/forecast ratio like "4.5x forecasted"
- If empty: show "No Excess Inventory" message

Use lucide-react icons: AlertTriangle for shortages, TrendingUp for excess.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles. Verify all 4 component files exist and export their main components. Check that Alert component from shadcn/ui is available.
  </verify>
  <done>
Brand selector, demand summary card, shortage alerts, and excess alerts components exist. All use shadcn/ui primitives (Card, Alert, Badge, Select). Visual indicators use color coding (red for shortage, amber for excess, green for healthy).
  </done>
</task>

<task type="auto">
  <name>Task 2: Demand dashboard pages (cross-brand, retailer, SKU)</name>
  <files>
    src/app/(dashboard)/demand/page.tsx
    src/app/(dashboard)/demand/by-retailer/page.tsx
    src/app/(dashboard)/demand/by-sku/page.tsx
  </files>
  <action>
Create `src/app/(dashboard)/demand/page.tsx` (Cross-Brand Demand Summary):
- "use client" page
- State: `selectedBrandId` (number | undefined), `monthRange` (default: current month to +3 months, computed with date-fns `startOfMonth(new Date())` and `addMonths()`)
- Queries: `trpc.demand.crossBrandSummary.useQuery({ monthStart, monthEnd, brandId })`, `trpc.alerts.shortages.useQuery({ brandId, limit: 5 })`, `trpc.alerts.excesses.useQuery({ brandId, limit: 5 })`
- Layout:
  - Page header: "Demand Summary" title + BrandSelector inline
  - Summary cards row: One DemandSummaryCard per brand (or filtered brand) showing totals
  - Two-column grid below:
    - Left: ShortageAlerts panel (top 5 shortage SKUs)
    - Right: ExcessAlerts panel (top 5 excess SKUs)
  - Main table: TanStack Table (reuse DataTable pattern from existing codebase) with columns:
    - Brand, Month (formatted MMM yyyy), Forecasted, Ordered, On Hand, In Transit, Available, Balance
    - Balance column: green badge if >= 0, red badge if < 0
  - Loading states: use Skeleton component during data fetch
  - Empty state: "No forecast data available. Import forecasts via the Import page."

Create `src/app/(dashboard)/demand/by-retailer/page.tsx` (Retailer Breakdown):
- "use client" page
- State: `selectedBrandId`, `selectedMonth` (default: startOfMonth current month)
- Month selector: simple shadcn Select with current month and past 3 months as options
- Query: `trpc.demand.retailerBreakdown.useQuery({ month, brandId })`
- BrandSelector for filtering
- Table columns: Retailer Name, Brand, Forecasted Units, Ordered Units, Gap (forecasted - ordered)
- Gap column: red text if positive gap (forecasted > ordered means unmet demand)
- Sort by retailer name, then brand name

Create `src/app/(dashboard)/demand/by-sku/page.tsx` (SKU Drill-Down):
- "use client" page
- State: `selectedBrandId`, `selectedMonth`, pagination state (page, limit=50)
- Query: `trpc.demand.skuDrillDown.useQuery({ month, brandId, limit, offset })`
- BrandSelector + Month selector
- Table columns: SKU, SKU Name, Brand, Forecasted, Ordered, On Hand, In Transit, Allocated, Available, Shortage, Excess
- Shortage column: red Badge with unit count if > 0, empty if 0
- Excess column: amber Badge with unit count if > 0, empty if 0
- Pagination controls at bottom (Previous/Next buttons with page info)
- Column sorting via TanStack Table

For all pages: follow existing DataTable pattern from the codebase. Use the same Tailwind spacing and card styling as existing pages (e.g., brands page, forecasts page). Non-technical users: keep layouts clean, use readable labels, avoid jargon.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles. Verify all 3 page files exist. Check that each page imports from demand components and trpc. Run `npm run build` to verify pages compile in Next.js build.
  </verify>
  <done>
Three demand dashboard pages exist: /demand (cross-brand summary with alert panels), /demand/by-retailer (retailer breakdown), /demand/by-sku (SKU drill-down). All pages use BrandSelector for filtering. Shortage and excess badges display on relevant rows. Tables follow existing DataTable patterns. Pages compile and render.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Three pages exist at /demand, /demand/by-retailer, /demand/by-sku
4. BrandSelector component works across all three pages
5. Shortage alerts show red badges, excess alerts show amber/warning badges
6. Tables display correct columns with proper data formatting
</verification>

<success_criteria>
- Cross-brand demand page shows forecasted vs ordered vs available per brand per month (DEM-01)
- Retailer breakdown shows per-retailer needs across brands (DEM-02)
- SKU drill-down shows full balance sheet per SKU with shortage/excess flags (DEM-03, DEM-04, DEM-05)
- Brand selector filters all views (UX-01)
- UI is clean and readable for non-technical users
</success_criteria>

<output>
After completion, create `.planning/phases/03-sellercloud-integration-demand-visibility/03-03-SUMMARY.md`
</output>
