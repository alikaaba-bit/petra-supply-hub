---
phase: 03-sellercloud-integration-demand-visibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/server/services/sellercloud-client.ts
  - src/server/db/schema.ts
  - src/server/api/routers/sellercloud.ts
autonomous: true
user_setup:
  - service: sellercloud
    why: "ERP data source for POs, inventory, shipments"
    env_vars:
      - name: SELLERCLOUD_BASE_URL
        source: "SellerCloud VPS — base URL of the SellerCloud instance (e.g., https://yourcompany.sellercloud.com)"
      - name: SELLERCLOUD_USERNAME
        source: "SellerCloud admin credentials"
      - name: SELLERCLOUD_PASSWORD
        source: "SellerCloud admin credentials"

must_haves:
  truths:
    - "SellerCloud API client can authenticate and fetch POs with retry logic"
    - "Sync tracking tables prevent duplicate imports via unique SellerCloud ID constraints"
    - "tRPC router file exists with sync procedures for POs and inventory"
  artifacts:
    - path: "src/server/services/sellercloud-client.ts"
      provides: "Authenticated API client with retry, backoff, token refresh"
      min_lines: 80
    - path: "src/server/db/schema.ts"
      provides: "sellercloudSyncLog and sellercloudIdMap tables"
      contains: "sellercloud_sync_log"
    - path: "src/server/api/routers/sellercloud.ts"
      provides: "syncPurchaseOrders, syncInventory, syncStatus procedures"
      min_lines: 60
  key_links:
    - from: "src/server/api/routers/sellercloud.ts"
      to: "src/server/services/sellercloud-client.ts"
      via: "import and instantiation"
      pattern: "SellerCloudClient|getSellerCloudClient"
    - from: "src/server/api/routers/sellercloud.ts"
      to: "src/server/db/schema.ts"
      via: "upsert to sync tracking tables"
      pattern: "sellercloudSyncLog|sellercloudIdMap"
---

<objective>
Build the SellerCloud API integration layer: authenticated HTTP client with retry/backoff, sync tracking schema to prevent duplicates, and tRPC router file with manual data sync procedures for purchase orders and inventory.

Purpose: Enables automated data pull from SellerCloud ERP (DAT-02), the foundation that all demand visibility features depend on for real inventory and PO data.
Output: API client service, 2 new database tables, sellercloud tRPC router file (router registration in root.ts deferred to Plan 02 to avoid file conflicts).
</objective>

<execution_context>
@/Users/kaaba/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kaaba/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-sellercloud-integration-demand-visibility/03-RESEARCH.md
@src/server/db/schema.ts
@src/server/api/root.ts
@src/server/api/trpc.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: SellerCloud API client and sync tracking schema</name>
  <files>
    src/server/services/sellercloud-client.ts
    src/server/db/schema.ts
  </files>
  <action>
Create `src/server/services/sellercloud-client.ts` with a `SellerCloudClient` class:
- Constructor takes `baseUrl`, `username`, `password` from env vars (`SELLERCLOUD_BASE_URL`, `SELLERCLOUD_USERNAME`, `SELLERCLOUD_PASSWORD`)
- `authenticate()` method: POST to `{baseUrl}/api/token` with `{ Username, Password }`, stores token and expiry (60 min from now). Throw descriptive error on auth failure.
- `fetchWithRetry(url, options, maxRetries=3)` method:
  - Check token expiry before each call, re-authenticate if < 5 minutes remaining
  - On 429: exponential backoff with jitter (1s base, 8s max, random 0-1s jitter)
  - On 401: re-authenticate once and retry
  - On 500/503: retry with backoff
  - On network error: retry with backoff
  - Return response on success, throw on exhausted retries
- `getPurchaseOrders(params)` method: GET `/api/purchaseorders` with pagination (pageNumber, pageSize=100), optional status filter, optional date range (`createDateFrom`/`createDateTo` in `MM/dd/yyyy HH:mm` format using date-fns `format()`). Returns `{ items, totalResults }`.
- `getInventoryForProduct(productId)` method: POST `/api/Inventory/Details` (not GET endpoint which has special char issues per research). Returns inventory details.
- `getAllPurchaseOrders(params)` helper: Auto-paginate through all pages, calling `getPurchaseOrders` repeatedly until all items fetched. Returns combined array.
- Export singleton factory: `getSellerCloudClient()` that creates/reuses single instance.

Add to `src/server/db/schema.ts` (append after auditLog table, before relations section):

1. `sellercloudSyncLog` table:
   - `id` serial PK
   - `entityType` varchar(50) not null (e.g., "purchase_order", "inventory")
   - `syncStartedAt` timestamp not null defaultNow
   - `syncCompletedAt` timestamp nullable
   - `status` varchar(20) not null default "running" (running, completed, failed)
   - `recordsProcessed` integer default 0
   - `recordsCreated` integer default 0
   - `recordsUpdated` integer default 0
   - `errorMessage` text nullable
   - `triggeredBy` text references users.id
   - Index on `(entityType, syncStartedAt)`

2. `sellercloudIdMap` table:
   - `id` serial PK
   - `entityType` varchar(50) not null
   - `sellercloudId` varchar(100) not null
   - `localTableName` varchar(100) not null
   - `localId` integer not null
   - `rawData` text nullable (JSON string of original API response)
   - `lastSyncedAt` timestamp not null defaultNow
   - Unique constraint on `(entityType, sellercloudId)`
   - Index on `(localTableName, localId)`

Add Drizzle relations for the new tables (sellercloudSyncLog -> users via triggeredBy).

Do NOT add node-cron or any scheduler. This is manual-trigger only for now.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles without errors. Check that schema.ts exports the 2 new tables. Check that sellercloud-client.ts exports `SellerCloudClient` class and `getSellerCloudClient` factory.
  </verify>
  <done>
SellerCloudClient class exists with authenticate, fetchWithRetry, getPurchaseOrders, getInventoryForProduct, getAllPurchaseOrders methods. Two new schema tables (sellercloudSyncLog, sellercloudIdMap) exist with proper indexes and unique constraints. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: SellerCloud sync tRPC router</name>
  <files>
    src/server/api/routers/sellercloud.ts
  </files>
  <action>
Create `src/server/api/routers/sellercloud.ts` with these procedures. Do NOT modify root.ts here — Plan 02 will register all new routers at once to avoid file conflicts with parallel execution.

Export `sellercloudRouter` with:

1. `syncPurchaseOrders` mutation (protectedProcedure):
   - Input: `{ dateFrom?: Date, dateTo?: Date, statuses?: string[] }` (optional filters)
   - Creates a sync log entry with entityType "purchase_order", status "running"
   - Uses `getSellerCloudClient()` to fetch all POs via `getAllPurchaseOrders()`
   - For each PO from SellerCloud:
     a. Check `sellercloudIdMap` for existing mapping (entityType "purchase_order", sellercloudId = PO.ID as string)
     b. If exists and rawData changed: update local purchaseOrders record and sellercloudIdMap.rawData + lastSyncedAt
     c. If not exists: INSERT into purchaseOrders (map fields: PONumber->poNumber, VendorID->supplier as string for now, Status->status mapped to local values, OrderDate->orderDate, etc.), then INSERT sellercloudIdMap
   - Map SellerCloud PO statuses to local: Saved->draft, Ordered->ordered, Received->received, Pending->pending, Cancelled->cancelled, Completed->completed
   - Update sync log with recordsProcessed/Created/Updated counts and status "completed"
   - On error: update sync log status to "failed" with errorMessage, re-throw
   - Return `{ syncLogId, recordsProcessed, recordsCreated, recordsUpdated }`

2. `syncInventory` mutation (protectedProcedure):
   - Input: `{ skuIds?: number[] }` (optional filter, defaults to all SKUs)
   - Creates sync log entry with entityType "inventory"
   - For each SKU in the database (or filtered subset):
     a. Call `getInventoryForProduct(sku.sku)` — use the SKU code string as the product identifier
     b. Upsert into inventory table (quantityOnHand, quantityInTransit, quantityAllocated, source="sellercloud")
   - Update sync log and return counts
   - Handle gracefully if SellerCloud credentials are not configured (check env vars, return early with descriptive message)

3. `syncStatus` query (protectedProcedure):
   - No input
   - Returns last 10 sync log entries ordered by syncStartedAt desc
   - Include counts of each entityType's most recent successful sync

4. `lastSync` query (protectedProcedure):
   - Input: `{ entityType: string }`
   - Returns the most recent completed sync log for that entity type

Important: Wrap the entire sync logic in try/catch. If SELLERCLOUD_BASE_URL is not set, the sync mutations should return `{ error: "SellerCloud not configured. Set SELLERCLOUD_BASE_URL, SELLERCLOUD_USERNAME, SELLERCLOUD_PASSWORD in .env", syncLogId: 0, recordsProcessed: 0, recordsCreated: 0, recordsUpdated: 0 }` instead of throwing.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles. Check that sellercloud.ts exports `sellercloudRouter`. Check that all 4 procedures exist (syncPurchaseOrders, syncInventory, syncStatus, lastSync).
  </verify>
  <done>
SellerCloud tRPC router exists with syncPurchaseOrders mutation, syncInventory mutation, syncStatus query, and lastSync query. Graceful handling when env vars not configured. Idempotent upsert via sellercloudIdMap prevents duplicate imports. Router exported but NOT yet registered in root.ts (deferred to Plan 02).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `src/server/services/sellercloud-client.ts` exports SellerCloudClient and getSellerCloudClient
3. `src/server/db/schema.ts` contains sellercloudSyncLog and sellercloudIdMap tables
4. `src/server/api/routers/sellercloud.ts` exports sellercloudRouter with 4 procedures
</verification>

<success_criteria>
- SellerCloud API client handles auth, retry, backoff, pagination
- Sync tracking tables exist with unique constraints to prevent duplicates
- tRPC router provides manual sync triggers and status queries
- Graceful degradation when SellerCloud credentials not configured
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-sellercloud-integration-demand-visibility/03-01-SUMMARY.md`
</output>
