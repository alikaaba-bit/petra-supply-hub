---
phase: 02-data-integration-manual-entry
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/(dashboard)/import/page.tsx
  - src/app/(dashboard)/import/_components/import-wizard.tsx
  - src/app/(dashboard)/import/_components/upload-dropzone.tsx
  - src/app/(dashboard)/import/_components/validation-results.tsx
  - src/app/(dashboard)/import/_components/preview-table.tsx
  - src/app/(dashboard)/import/_components/import-type-selector.tsx
  - src/app/(dashboard)/import/_components/commit-result.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /import and see options for forecast import and retail sales import"
    - "User can drag-drop or browse to select an .xlsx file, with clear file type and size constraints shown"
    - "After upload, user sees validation results: count of valid rows, warnings, and errors with row-level detail"
    - "If errors exist, user cannot proceed to import (must fix file and re-upload)"
    - "If validation passes, user sees a preview table of parsed data before committing"
    - "User can confirm import and see success result with count of imported/updated rows"
    - "User can cancel at any step and return to upload"
    - "Forecast import auto-detects RTL vs HOP format and shows detected format to user"
  artifacts:
    - path: "src/app/(dashboard)/import/page.tsx"
      provides: "Import landing page with type selection"
      min_lines: 20
    - path: "src/app/(dashboard)/import/_components/import-wizard.tsx"
      provides: "Multi-step wizard container managing upload->validate->preview->commit flow"
      min_lines: 80
    - path: "src/app/(dashboard)/import/_components/upload-dropzone.tsx"
      provides: "Drag-drop file upload component using react-dropzone"
      min_lines: 40
    - path: "src/app/(dashboard)/import/_components/validation-results.tsx"
      provides: "Validation summary cards and error/warning list"
      min_lines: 60
    - path: "src/app/(dashboard)/import/_components/preview-table.tsx"
      provides: "Preview table showing parsed data before commit"
      min_lines: 40
  key_links:
    - from: "src/app/(dashboard)/import/_components/import-wizard.tsx"
      to: "src/server/actions/import-forecast.ts"
      via: "Server Action call for parse and validate"
      pattern: "parseAndValidateForecast"
    - from: "src/app/(dashboard)/import/_components/import-wizard.tsx"
      to: "src/server/actions/import-sales.ts"
      via: "Server Action call for sales parse and validate"
      pattern: "parseAndValidateSales"
    - from: "src/app/(dashboard)/import/_components/import-wizard.tsx"
      to: "src/server/actions/import-forecast.ts"
      via: "Server Action call to commit import"
      pattern: "commitForecastImport"
---

<objective>
Build the complete Excel import wizard UI with the multi-step upload -> validate -> preview -> commit flow for both forecast and retail sales data.

Purpose: This is the primary data entry mechanism for Phase 2 -- the team uploads their existing Excel forecast files and retail sales reports through this wizard. The UI must be clear and intuitive for non-technical users, showing exactly what will be imported before committing.

Output: Working /import page with drag-drop upload, format auto-detection, validation results display, data preview table, and commit confirmation. Both forecast and retail sales import flows functional end-to-end.
</objective>

<execution_context>
@/Users/kaaba/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kaaba/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-integration-manual-entry/02-RESEARCH.md
@.planning/phases/02-data-integration-manual-entry/02-01-SUMMARY.md

Key source files:
@src/server/actions/import-forecast.ts — Server Actions to call (parseAndValidateForecast, commitForecastImport)
@src/server/actions/import-sales.ts — Server Actions to call (parseAndValidateSales, commitSalesImport)
@src/server/services/validators/forecast-validator.ts — ValidationResult type definition
@src/app/(dashboard)/layout.tsx — Dashboard layout (sidebar + main content area)
@src/components/dashboard/data-table.tsx — Existing DataTable pattern to reference for preview table
@src/app/(dashboard)/skus/page.tsx — Example page pattern (client component, tRPC queries, DataTable usage)
@src/components/ui/card.tsx — Card component pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build the import wizard page and all subcomponents</name>
  <files>
    src/app/(dashboard)/import/page.tsx
    src/app/(dashboard)/import/_components/import-type-selector.tsx
    src/app/(dashboard)/import/_components/upload-dropzone.tsx
    src/app/(dashboard)/import/_components/validation-results.tsx
    src/app/(dashboard)/import/_components/preview-table.tsx
    src/app/(dashboard)/import/_components/commit-result.tsx
    src/app/(dashboard)/import/_components/import-wizard.tsx
  </files>
  <action>
    Build the complete import flow. All components are "use client" since they manage interactive state.

    **A. Import Type Selector** (`import-type-selector.tsx`):
    - Simple card-based selector with two options:
      1. "Forecast Import" -- icon: TrendingUp -- description: "Upload RTL FORECAST_MASTER or HOP product-centric Excel files"
      2. "Retail Sales Import" -- icon: ShoppingCart -- description: "Upload retail sales performance data by SKU"
    - Each option is a Card with hover state. Clicking sets the import type and moves to the wizard.
    - Props: `onSelect: (type: 'forecast' | 'sales') => void`

    **B. Upload Dropzone** (`upload-dropzone.tsx`):
    - Use `react-dropzone` with `useDropzone` hook.
    - Accept only `.xlsx` files: `accept: { 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'] }`
    - Max size: 10MB (10 * 1024 * 1024).
    - Single file only (`maxFiles: 1, multiple: false`).
    - Visual states:
      - Default: dashed border, FileSpreadsheet icon, "Drag & drop Excel file here, or click to browse" text, ".xlsx files up to 10MB" subtext.
      - Drag active: primary color border, light primary background, "Drop Excel file here" text.
      - File selected: show file name, size, and a "Remove" button (X icon) to clear.
      - Rejection: red border area with error message (wrong type, too large).
    - Props: `onFileSelected: (file: File) => void; selectedFile: File | null; onClear: () => void`
    - Use `cn()` from `@/lib/utils` for conditional classes.
    - Icons from lucide-react: FileSpreadsheet, Upload, X.

    **C. Validation Results** (`validation-results.tsx`):
    - Three summary cards in a grid (matching the StatCard pattern):
      1. Green CheckCircle2 icon + valid row count + "Valid rows" label
      2. Yellow AlertTriangle icon + warning count + "Warnings" label
      3. Red AlertCircle icon + error count + "Errors" label
    - If errors > 0:
      - Red-bordered Card with "Errors must be fixed before import" header.
      - ScrollArea (max height 300px) listing each error: "Row {N}: {field} - {message}"
      - Bottom: disabled destructive button "Fix {N} errors to continue"
    - If warnings > 0 but errors = 0:
      - Yellow-bordered Card with "Warnings (will proceed)" header.
      - ScrollArea listing warnings.
    - If no errors:
      - "Continue to Preview" primary button and "Cancel" outline button.
    - Show detected format as a Badge: "Detected: RTL FORECAST_MASTER" or "Detected: HOP Forecast" or "Retail Sales".
    - Props: `errors: ValidationError[]; warnings: ValidationWarning[]; validCount: number; format?: string; onContinue: () => void; onCancel: () => void`

    **D. Preview Table** (`preview-table.tsx`):
    - Use the existing DataTable component pattern from the codebase.
    - For forecasts: columns = SKU, Retailer, Month (formatted with date-fns `format(month, 'MMM yyyy')`), Forecasted Units.
    - For retail sales: columns = SKU, Retailer, Month, Units Sold, Revenue.
    - Show "Showing first {N} of {total} rows" text above table.
    - Two buttons at bottom: "Cancel" (outline) and "Import {total} rows" (primary, with count in button text).
    - Props: `data: any[]; totalRows: number; importType: 'forecast' | 'sales'; onConfirm: () => void; onCancel: () => void`

    **E. Commit Result** (`commit-result.tsx`):
    - Success state: Large green CheckCircle2 icon, "Import Complete" heading, "{N} rows imported, {M} rows updated" text.
    - Button: "Import Another File" (outline) to restart wizard.
    - Button: "View Forecasts" or "View Sales" (primary) to navigate to the relevant data page (for now, link to /import since dedicated pages come later -- or link to dashboard).
    - Props: `imported: number; updated: number; importType: 'forecast' | 'sales'; onReset: () => void`

    **F. Import Wizard** (`import-wizard.tsx`):
    - This is the orchestrator component. Manages wizard state machine.
    - State:
      ```typescript
      type WizardStep = 'upload' | 'validating' | 'results' | 'preview' | 'committing' | 'complete'
      const [step, setStep] = useState<WizardStep>('upload')
      const [file, setFile] = useState<File | null>(null)
      const [validationResult, setValidationResult] = useState<any>(null)
      const [commitResult, setCommitResult] = useState<any>(null)
      const [error, setError] = useState<string | null>(null)
      ```
    - Props: `importType: 'forecast' | 'sales'`
    - Step indicator at top: horizontal stepper showing 4 steps (Upload, Validate, Preview, Import) with active/completed/pending states. Use simple div-based stepper (circles connected by lines), no need for a stepper library.
    - Step flow:
      1. **upload**: Show UploadDropzone. When file selected, auto-advance to 'validating'.
      2. **validating**: Show a loading spinner/skeleton with "Parsing and validating file..." text. Call the appropriate Server Action:
         - For forecast: `const formData = new FormData(); formData.append('file', file); const result = await parseAndValidateForecast(formData);`
         - For sales: `const result = await parseAndValidateSales(formData);`
         - On success: set validationResult, advance to 'results'.
         - On error: set error message, stay on upload step, show toast error.
      3. **results**: Show ValidationResults. If user clicks "Continue", advance to 'preview'. If "Cancel", reset to 'upload'.
      4. **preview**: Show PreviewTable with validationResult.previewData. If user clicks "Import", advance to 'committing'.
      5. **committing**: Show loading with "Importing data..." text. Call commit Server Action:
         - For forecast: `const result = await commitForecastImport(validationResult.valid);`
         - For sales: `const result = await commitSalesImport(validationResult.valid);`
         - On success: set commitResult, advance to 'complete'.
         - On error: show toast, return to 'preview'.
      6. **complete**: Show CommitResult with imported/updated counts.
    - "Back" button at each step (except upload and complete) to go to previous step.
    - Toast notifications via sonner for errors.
    - Wrap Server Action calls in try/catch. Use `useTransition` from React for pending state during Server Action calls.

    **G. Import Page** (`page.tsx`):
    - "use client" component.
    - State: `importType: 'forecast' | 'sales' | null`
    - When importType is null: show page header ("Data Import" / "Upload Excel files to import forecast and sales data") + ImportTypeSelector.
    - When importType is set: show page header with back button (to return to type selection) + ImportWizard with the selected type.
    - Page layout follows existing pattern: `<div className="space-y-6">` with header section + content.

    **Important implementation details:**
    - Server Actions are imported at top of import-wizard.tsx: `import { parseAndValidateForecast, commitForecastImport } from '@/server/actions/import-forecast'`
    - The Server Action returns serializable data only (no Date objects over the wire -- dates should be ISO strings).
    - For the preview table, since we need DataTable columns, define inline column defs using ColumnDef from @tanstack/react-table.
    - The validated rows returned from Server Actions have dates as ISO strings (serialized for wire transfer). Store them in React state as-is. When passing to commitForecastImport/commitSalesImport, the Server Action will deserialize dates and re-validate IDs.
    - For month display, use `format(new Date(row.month), 'MMM yyyy')` from date-fns (already installed).
    - shadcn scroll-area, progress, and select components are pre-installed by Plan 02-01.
    - All user-facing text should be clear for non-technical users (avoid jargon like "upsert" or "validation schema").
  </action>
  <verify>
    1. `npm run build` passes with no errors.
    2. All component files exist: `ls src/app/(dashboard)/import/page.tsx src/app/(dashboard)/import/_components/*.tsx`
    3. Navigate to http://localhost:3000/import (when dev server running) shows the import type selector.
    4. `grep "parseAndValidateForecast" src/app/(dashboard)/import/_components/import-wizard.tsx` confirms Server Action wiring.
    5. `grep "react-dropzone" src/app/(dashboard)/import/_components/upload-dropzone.tsx` confirms dropzone usage.
  </verify>
  <done>
    Complete import wizard UI at /import:
    - Import type selector (forecast vs retail sales) with card-based selection
    - Drag-drop file upload with .xlsx validation and 10MB limit
    - Automatic format detection (RTL vs HOP) shown to user
    - Validation results with error/warning counts and row-level details
    - Preview table showing parsed data before commit
    - Commit confirmation with imported/updated row counts
    - Cancel and back navigation at every step
    - Build passes with no errors
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. /import page renders import type selection
3. Selecting "Forecast Import" shows the wizard with upload step
4. All wizard components exist and are properly imported
5. Server Action imports are correctly wired in the wizard
6. UI follows existing codebase patterns (shadcn/ui, Tailwind, lucide-react icons)
</verification>

<success_criteria>
- /import page accessible from dashboard
- Two import types available: forecast and retail sales
- Drag-drop file upload accepts .xlsx only, shows file info
- Validation step shows errors, warnings, valid counts in cards
- Errors block progression (cannot import with errors)
- Preview table shows first N rows of parsed data
- Commit step imports data and shows success result
- User can cancel and restart at any point
- All components build without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-integration-manual-entry/02-02-SUMMARY.md`
</output>
