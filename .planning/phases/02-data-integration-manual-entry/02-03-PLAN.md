---
phase: 02-data-integration-manual-entry
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/(dashboard)/orders/purchase-orders/page.tsx
  - src/app/(dashboard)/orders/purchase-orders/columns.tsx
  - src/app/(dashboard)/orders/purchase-orders/new/page.tsx
  - src/app/(dashboard)/orders/purchase-orders/[id]/page.tsx
  - src/app/(dashboard)/orders/retail-orders/page.tsx
  - src/app/(dashboard)/orders/retail-orders/columns.tsx
  - src/app/(dashboard)/orders/retail-orders/new/page.tsx
  - src/app/(dashboard)/orders/retail-orders/[id]/page.tsx
  - src/components/dashboard/app-sidebar.tsx
  - src/app/(dashboard)/page.tsx
  - src/app/(dashboard)/forecasts/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to Purchase Orders page from sidebar and see a list of all POs with status, brand, supplier, date, and amount"
    - "User can create a new purchase order with line items (SKU + quantity + unit cost) through a form"
    - "User can view a purchase order's details including all line items"
    - "User can navigate to Retail Orders page from sidebar and see a list of all retail orders with status, retailer, brand, and date"
    - "User can create a new retail order with line items (SKU + quantity + unit price) through a form"
    - "User can view a retail order's details including all line items"
    - "Sidebar shows Data section (Import, Forecasts) and Orders section (Purchase Orders, Retail Orders)"
    - "Dashboard stat cards include counts for Purchase Orders, Retail Orders, and Forecasts"
    - "User can navigate to /forecasts and see imported forecast data in a filterable DataTable"
  artifacts:
    - path: "src/app/(dashboard)/orders/purchase-orders/page.tsx"
      provides: "Purchase orders list page with DataTable"
      min_lines: 40
    - path: "src/app/(dashboard)/orders/purchase-orders/columns.tsx"
      provides: "Column definitions for purchase orders table"
      min_lines: 30
    - path: "src/app/(dashboard)/orders/purchase-orders/new/page.tsx"
      provides: "Create purchase order form with line items"
      min_lines: 80
    - path: "src/app/(dashboard)/orders/retail-orders/page.tsx"
      provides: "Retail orders list page with DataTable"
      min_lines: 40
    - path: "src/app/(dashboard)/orders/retail-orders/columns.tsx"
      provides: "Column definitions for retail orders table"
      min_lines: 30
    - path: "src/app/(dashboard)/orders/retail-orders/new/page.tsx"
      provides: "Create retail order form with line items"
      min_lines: 80
    - path: "src/components/dashboard/app-sidebar.tsx"
      provides: "Updated sidebar with Data and Orders sections"
      min_lines: 50
    - path: "src/app/(dashboard)/page.tsx"
      provides: "Updated dashboard with PO, retail order, and forecast stat cards"
      min_lines: 40
    - path: "src/app/(dashboard)/forecasts/page.tsx"
      provides: "Forecasts list page showing imported forecast data with filters"
      min_lines: 40
  key_links:
    - from: "src/app/(dashboard)/orders/purchase-orders/page.tsx"
      to: "src/server/api/routers/orders.ts"
      via: "tRPC query for purchase orders list"
      pattern: "trpc\\.orders\\.purchaseOrders\\.list"
    - from: "src/app/(dashboard)/orders/purchase-orders/new/page.tsx"
      to: "src/server/api/routers/orders.ts"
      via: "tRPC mutation for creating purchase order"
      pattern: "trpc\\.orders\\.purchaseOrders\\.create"
    - from: "src/app/(dashboard)/orders/retail-orders/page.tsx"
      to: "src/server/api/routers/orders.ts"
      via: "tRPC query for retail orders list"
      pattern: "trpc\\.orders\\.retailOrders\\.list"
    - from: "src/components/dashboard/app-sidebar.tsx"
      to: "src/app/(dashboard)/import/page.tsx"
      via: "navigation link"
      pattern: "href.*import"
    - from: "src/app/(dashboard)/page.tsx"
      to: "src/server/api/routers/orders.ts"
      via: "tRPC count queries"
      pattern: "trpc\\.orders\\.purchaseOrders\\.count"
---

<objective>
Build manual order entry forms, order list pages, update sidebar navigation, and expand dashboard stats for the complete Phase 2 data entry experience.

Purpose: This plan delivers the manual data entry capability (DAT-03) so the team can create purchase orders and retail orders when Excel data is incomplete or unavailable. It also organizes the sidebar navigation to expose all Phase 2 features (import + orders) and adds operational stat cards to the dashboard.

Output: Working purchase order and retail order CRUD pages with line item management, updated sidebar with Data and Orders sections, dashboard showing PO/retail order/forecast counts.
</objective>

<execution_context>
@/Users/kaaba/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kaaba/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-integration-manual-entry/02-01-SUMMARY.md

Key source files:
@src/server/api/routers/orders.ts — Orders tRPC router (from Plan 01)
@src/server/api/routers/import.ts — Import tRPC router with forecast/sales counts (from Plan 01)
@src/server/db/schema.ts — purchaseOrders, poLineItems, retailOrders, retailOrderLineItems schemas
@src/components/dashboard/app-sidebar.tsx — Current sidebar (needs Data + Orders sections added)
@src/app/(dashboard)/page.tsx — Current dashboard (needs PO + retail order + forecast stat cards)
@src/app/(dashboard)/skus/page.tsx — Example list page pattern to follow
@src/app/(dashboard)/skus/columns.tsx — Example column definitions pattern
@src/components/dashboard/data-table.tsx — Reusable DataTable component
@src/components/dashboard/brand-form-dialog.tsx — Example form dialog pattern
@src/components/dashboard/stat-card.tsx — StatCard component
@src/lib/trpc.ts — tRPC client hook
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build purchase order pages (list, columns, create form, detail)</name>
  <files>
    src/app/(dashboard)/orders/purchase-orders/page.tsx
    src/app/(dashboard)/orders/purchase-orders/columns.tsx
    src/app/(dashboard)/orders/purchase-orders/new/page.tsx
    src/app/(dashboard)/orders/purchase-orders/[id]/page.tsx
  </files>
  <action>
    Build 4 purchase order files. Follow existing patterns from SKUs page.

    **A. Purchase Orders Columns** (`orders/purchase-orders/columns.tsx`):
    - Define `PurchaseOrder` type matching the router's list response:
      ```typescript
      export type PurchaseOrder = {
        id: number;
        poNumber: string;
        brand: { id: number; name: string } | null;
        supplier: string | null;
        status: string;
        orderDate: Date | null;
        expectedArrival: Date | null;
        totalAmount: string | null;
        currency: string | null;
        createdAt: Date;
      }
      ```
    - Export `createColumns` function (same pattern as SKU columns) accepting `onEdit` and `onDelete` callbacks.
    - Columns: PO Number (sortable), Brand (brand.name), Supplier, Status (Badge component with color coding: draft=gray, submitted=blue, confirmed=green, in_production=yellow, shipped=purple, in_transit=orange, received=green, cancelled=red), Order Date (formatted), Expected Arrival (formatted), Total Amount (formatted with currency), Actions (edit/delete dropdown).
    - Use `format(date, 'MMM dd, yyyy')` from date-fns for date formatting.
    - For status badge colors, use a helper function mapping status string to Badge variant.

    **B. Purchase Orders List** (`orders/purchase-orders/page.tsx`):
    - "use client" component.
    - Follow SKUs page pattern exactly:
      - Page header: "Purchase Orders" title, "Manage supplier purchase orders" description.
      - "New Order" button (links to `/orders/purchase-orders/new` using Next.js Link or router.push).
      - Optional brand filter dropdown (same pattern as SKU page's brand filter).
      - Optional status filter dropdown.
      - DataTable with purchase order columns.
    - Query: `trpc.orders.purchaseOrders.list.useQuery({ brandId, status })` (pass filters).
    - Delete mutation: `trpc.orders.purchaseOrders.delete.useMutation()` with toast and invalidation.
    - Edit action: navigate to `/orders/purchase-orders/{id}` (detail page doubles as edit).

    **C. Create Purchase Order Form** (`orders/purchase-orders/new/page.tsx`):
    - "use client" component.
    - Full-page form (not a dialog, since POs have line items that need space).
    - Page header: "Create Purchase Order" with "Back to Purchase Orders" link.
    - Form fields (use react-hook-form with zodResolver):
      - PO Number: text input, required. Auto-generate suggestion: `PO-{YYYYMMDD}-{NNN}` format.
      - Brand: select dropdown populated from `trpc.brands.list.useQuery()`. Required.
      - Supplier: text input, optional.
      - Status: select dropdown with options: draft, submitted, confirmed. Default: draft.
      - Order Date: date input (HTML native `type="date"`). Default: today.
      - Expected Arrival: date input.
      - Currency: select with USD/RMB options. Default: USD.
      - Deposit Amount: number input.
      - Deposit Paid: checkbox.
      - Notes: textarea.
    - **Line Items section:**
      - Dynamic array of line items using `useFieldArray` from react-hook-form.
      - Each line item row: SKU dropdown (filtered by selected brand, populated from `trpc.skus.list.useQuery({ brandId })`), Quantity (number input, min 1), Unit Cost (number input, min 0).
      - "Add Line Item" button to append new row.
      - "Remove" button (X icon) on each row to remove.
      - Auto-calculate total cost per line = quantity * unitCost (display as read-only).
      - Auto-calculate PO total = sum of all line item totals (display at bottom).
      - At least 1 line item required (Zod validation: `lineItems.min(1)`).
    - Submit: call `trpc.orders.purchaseOrders.create.useMutation()`. On success, toast + navigate to `/orders/purchase-orders`. On error, toast error.
    - Zod schema for form:
      ```typescript
      const poFormSchema = z.object({
        poNumber: z.string().min(1, 'PO number is required'),
        brandId: z.number({ required_error: 'Brand is required' }),
        supplier: z.string().optional(),
        status: z.string().default('draft'),
        orderDate: z.string().optional(), // HTML date input returns string
        expectedArrival: z.string().optional(),
        currency: z.string().default('USD'),
        depositAmount: z.number().optional(),
        depositPaid: z.boolean().default(false),
        notes: z.string().optional(),
        lineItems: z.array(z.object({
          skuId: z.number({ required_error: 'SKU is required' }),
          quantity: z.number().int().min(1, 'Quantity must be at least 1'),
          unitCost: z.number().min(0).optional(),
        })).min(1, 'At least one line item is required'),
      })
      ```
    - Use shadcn/ui components: Input, Label, Button, Card, Select (for dropdowns).
    - Layout: Card-based sections -- "Order Details" card on top, "Line Items" card below.

    **D. Purchase Order Detail** (`orders/purchase-orders/[id]/page.tsx`):
    - "use client" component.
    - Extract id from params: `const params = useParams(); const id = Number(params.id);`
    - Query: `trpc.orders.purchaseOrders.getById.useQuery({ id })`.
    - Display all PO fields in a read-only card layout.
    - Display line items in a simple table (SKU code, SKU name, Quantity, Unit Cost, Total Cost).
    - "Back to Purchase Orders" link.
    - Show status with colored Badge.

    **Implementation notes:**
    - For date inputs, use HTML `<input type="date">` for simplicity. The value is ISO string (YYYY-MM-DD). Parse to Date when submitting to tRPC.
    - For select dropdowns, use shadcn/ui Select component (installed in Plan 02-01).
    - For the SKU dropdown filtered by brand: when brandId changes, refetch SKUs. Use `enabled: !!brandId` on the query.
    - For useFieldArray, import from `react-hook-form`.
    - Use `useRouter` from `next/navigation` for programmatic navigation after form submit.
    - Toast from sonner for success/error messages.
    - Auto-generate PO number suggestion on page load: `PO-${format(new Date(), 'yyyyMMdd')}-001`. User can override.
  </action>
  <verify>
    1. `npm run build` passes with no errors.
    2. All 4 files exist: `ls src/app/(dashboard)/orders/purchase-orders/page.tsx src/app/(dashboard)/orders/purchase-orders/columns.tsx src/app/(dashboard)/orders/purchase-orders/new/page.tsx "src/app/(dashboard)/orders/purchase-orders/[id]/page.tsx"`
    3. `grep "trpc.orders.purchaseOrders" src/app/(dashboard)/orders/purchase-orders/page.tsx` confirms tRPC wiring.
    4. `grep "useFieldArray" src/app/(dashboard)/orders/purchase-orders/new/page.tsx` confirms dynamic line items.
  </verify>
  <done>
    Purchase order pages functional:
    - List page with brand/status filters and DataTable
    - Create form with dynamic line items, auto-calculated totals, Zod validation
    - Detail view with line items table
    - Build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Build retail order pages (list, columns, create form, detail)</name>
  <files>
    src/app/(dashboard)/orders/retail-orders/page.tsx
    src/app/(dashboard)/orders/retail-orders/columns.tsx
    src/app/(dashboard)/orders/retail-orders/new/page.tsx
    src/app/(dashboard)/orders/retail-orders/[id]/page.tsx
  </files>
  <action>
    Build 4 retail order files. Same patterns as purchase order pages.

    **A. Retail Orders Columns** (`orders/retail-orders/columns.tsx`):
    - Same pattern as PO columns.
    - Type: `RetailOrder` with id, retailerPoNumber, retailer.name, brand.name, status, orderDate, shipByDate, totalAmount, createdAt.
    - Columns: PO Number (retailerPoNumber), Retailer, Brand, Status (badge: pending=gray, confirmed=green, processing=yellow, shipped=purple, delivered=green, cancelled=red), Order Date, Ship By Date, Total Amount, Actions.

    **B. Retail Orders List** (`orders/retail-orders/page.tsx`):
    - Same pattern as PO list page.
    - Query: `trpc.orders.retailOrders.list.useQuery({ retailerId, brandId, status })`.
    - Filters: retailer dropdown, brand dropdown, status dropdown.
    - "New Order" button links to `/orders/retail-orders/new`.

    **C. Create Retail Order Form** (`orders/retail-orders/new/page.tsx`):
    - Same structural pattern as PO form but with retail order fields.
    - Fields: Retailer PO Number (optional text), Retailer (select dropdown from retailers list), Brand (select from brands), Status (pending, confirmed, processing), Order Date, Ship By Date, Notes.
    - Line Items: SKU dropdown (filtered by brand), Quantity, Unit Price. Auto-calc total per line and order total.
    - Submit: `trpc.orders.retailOrders.create.useMutation()`.
    - Zod schema similar to PO schema but with retailerId instead of supplier.

    **D. Retail Order Detail** (`orders/retail-orders/[id]/page.tsx`):
    - Same pattern as PO detail page.
    - Show retailer info, brand, line items with SKU details.

    **Implementation notes:**
    - Use same shadcn/ui Select component (installed in Plan 02-01).
    - Follow same react-hook-form + useFieldArray patterns as PO create form.
    - Use `useRouter` from `next/navigation` for navigation after form submit.
  </action>
  <verify>
    1. `npm run build` passes with no errors.
    2. All 4 files exist: `ls src/app/(dashboard)/orders/retail-orders/page.tsx src/app/(dashboard)/orders/retail-orders/columns.tsx src/app/(dashboard)/orders/retail-orders/new/page.tsx "src/app/(dashboard)/orders/retail-orders/[id]/page.tsx"`
    3. `grep "trpc.orders.retailOrders" src/app/(dashboard)/orders/retail-orders/page.tsx` confirms tRPC wiring.
    4. `grep "useFieldArray" src/app/(dashboard)/orders/retail-orders/new/page.tsx` confirms dynamic line items.
  </verify>
  <done>
    Retail order pages functional:
    - List page with retailer/brand/status filters
    - Create form with dynamic line items
    - Detail view with line items
    - Build passes
  </done>
</task>

<task type="auto">
  <name>Task 3: Update sidebar navigation, dashboard stats, and add forecasts list page</name>
  <files>
    src/components/dashboard/app-sidebar.tsx
    src/app/(dashboard)/page.tsx
    src/app/(dashboard)/forecasts/page.tsx
  </files>
  <action>
    **A. Update Sidebar** (`src/components/dashboard/app-sidebar.tsx`):
    - Restructure sidebar navigation into grouped sections:
      1. **Overview** group:
         - Dashboard (/, LayoutDashboard icon) -- existing
      2. **Data** group:
         - Import (/import, Upload icon from lucide-react)
         - Forecasts (/forecasts, TrendingUp icon from lucide-react)
      3. **Orders** group:
         - Purchase Orders (/orders/purchase-orders, ShoppingBag icon)
         - Retail Orders (/orders/retail-orders, ShoppingCart icon)
      4. **Master Data** group:
         - Brands (/brands, Package icon) -- existing
         - SKUs (/skus, Box icon) -- existing
         - Retailers (/retailers, Store icon) -- existing
      5. **System** group:
         - Audit Log (/audit, FileText icon) -- existing

    - Use SidebarGroup + SidebarGroupLabel for each section (already used for "Navigation" label).
    - Add imports for new icons: `Upload, ShoppingBag, ShoppingCart` from lucide-react.
    - Active state detection: use `pathname.startsWith(item.href)` for nested routes (e.g., /orders/purchase-orders/new should highlight Purchase Orders). But for "/" (Dashboard), use exact match `pathname === '/'`.
    - Keep the same SidebarMenuItem/SidebarMenuButton pattern.

    **B. Update Dashboard Stats** (`src/app/(dashboard)/page.tsx`):
    - Add new stat card queries:
      - `trpc.orders.purchaseOrders.count.useQuery()` -- "Purchase Orders"
      - `trpc.orders.retailOrders.count.useQuery()` -- "Retail Orders"
      - `trpc.import.forecasts.count.useQuery()` -- "Forecasts"
    - Update the grid from `md:grid-cols-3` to `md:grid-cols-3 lg:grid-cols-6` (or keep md:grid-cols-3 and let it wrap to 2 rows -- 2 rows of 3 is cleaner for 6 cards).
    - StatCard order: Brands, SKUs, Retailers, Purchase Orders, Retail Orders, Forecasts.
    - New icons: ShoppingBag for POs, ShoppingCart for Retail Orders, TrendingUp for Forecasts.
    - Update page description from "Overview of your supply chain master data" to "Overview of your supply chain data".

    **C. Forecasts List Page** (`src/app/(dashboard)/forecasts/page.tsx`):
    - "use client" component.
    - Page header: "Forecasts" title, "View imported forecast data" description.
    - Query: `trpc.import.forecasts.list.useQuery({ brandId, retailerId })` with optional brand and retailer filters.
    - DataTable with columns: SKU Code, SKU Name, Retailer, Month (formatted), Forecasted Units, Source.
    - Brand filter dropdown (from `trpc.brands.list.useQuery()`).
    - Retailer filter dropdown (from `trpc.retailers.list.useQuery()`).
    - This page satisfies SC-5: imported data appears immediately in a browsable dashboard view after import.

    **Implementation notes:**
    - The sidebar structure changes from a flat array to grouped arrays. Restructure the component to map over groups.
    - For the active state on nested routes, use a helper: `const isActive = item.href === '/' ? pathname === '/' : pathname.startsWith(item.href)`.
    - Keep the SidebarHeader ("Petra Supply Hub") and SidebarFooter ("Version 1.0.0") unchanged.
  </action>
  <verify>
    1. `npm run build` passes.
    2. `grep "Import" src/components/dashboard/app-sidebar.tsx` confirms Import link.
    3. `grep "Purchase Orders" src/components/dashboard/app-sidebar.tsx` confirms PO link.
    4. `grep "Forecasts" src/components/dashboard/app-sidebar.tsx` confirms Forecasts link.
    5. `grep "purchaseOrders.count" src/app/(dashboard)/page.tsx` confirms PO count stat card.
    6. `grep "forecasts.count" src/app/(dashboard)/page.tsx` confirms forecast count stat card.
    7. `ls src/app/(dashboard)/forecasts/page.tsx` confirms forecasts list page exists.
  </verify>
  <done>
    Sidebar updated with grouped navigation:
    - Overview: Dashboard
    - Data: Import, Forecasts
    - Orders: Purchase Orders, Retail Orders
    - Master Data: Brands, SKUs, Retailers
    - System: Audit Log

    Dashboard updated with 6 stat cards:
    - Brands, SKUs, Retailers (existing)
    - Purchase Orders, Retail Orders, Forecasts (new)
    - All counts query via tRPC

    Forecasts list page at /forecasts shows imported data with brand/retailer filters.
    - Build passes
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with all new pages
2. Sidebar shows 5 navigation groups with all expected links
3. Dashboard shows 6 stat cards
4. /orders/purchase-orders renders list page
5. /orders/purchase-orders/new renders create form
6. /orders/retail-orders renders list page
7. /orders/retail-orders/new renders create form
8. /forecasts renders imported forecast data
9. All pages follow existing DataTable and form patterns from Phase 1
</verification>

<success_criteria>
- Purchase order CRUD: list with filters, create with line items, view detail
- Retail order CRUD: list with filters, create with line items, view detail
- Line item forms support adding/removing rows with auto-calculated totals
- Sidebar reorganized into logical groups (Overview, Data, Orders, Master Data, System)
- Dashboard shows operational metrics (PO count, retail order count, forecast count) alongside master data counts
- Forecasts list page shows imported data with brand/retailer filtering
- All forms validate with Zod schemas and show appropriate error messages
- Navigation between list -> create -> detail works correctly
- Build passes with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-integration-manual-entry/02-03-SUMMARY.md`
</output>
