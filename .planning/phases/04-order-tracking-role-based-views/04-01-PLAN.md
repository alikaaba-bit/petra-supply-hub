---
phase: 04-order-tracking-role-based-views
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/server/api/routers/tracking.ts
  - src/server/api/root.ts
  - src/components/tracking/status-badge.tsx
  - src/components/tracking/lead-time-badge.tsx
  - src/components/tracking/po-timeline.tsx
  - src/components/tracking/order-status-card.tsx
  - src/lib/lead-time.ts
autonomous: true

must_haves:
  truths:
    - "Tracking tRPC router exposes supplier order queries with brand joins and lead time data"
    - "Tracking tRPC router exposes retail order queries with retailer joins and fulfillment status"
    - "Status badge component renders consistent colors for all PO and retail order statuses"
    - "PO timeline component renders 6-step lifecycle visualization with active/complete/pending states"
    - "Lead time badge shows urgency (overdue red, urgent amber, normal gray) based on order-by date"
    - "Lead time utility functions calculate order-by and expected arrival dates using brand leadTimeDays"
  artifacts:
    - path: "src/server/api/routers/tracking.ts"
      provides: "Tracking tRPC router with supplierOrders, retailOrders, supplierOrderDetail, retailOrderDetail, leadTimeOverview procedures"
      exports: ["trackingRouter"]
    - path: "src/server/api/root.ts"
      provides: "App router with tracking router registered"
      contains: "tracking: trackingRouter"
    - path: "src/components/tracking/status-badge.tsx"
      provides: "Consistent status badge for PO and retail order statuses"
      exports: ["StatusBadge"]
    - path: "src/components/tracking/lead-time-badge.tsx"
      provides: "Lead time urgency badge"
      exports: ["LeadTimeBadge"]
    - path: "src/components/tracking/po-timeline.tsx"
      provides: "PO lifecycle timeline visualization"
      exports: ["POTimeline"]
    - path: "src/components/tracking/order-status-card.tsx"
      provides: "Order status summary card with counts per status"
      exports: ["OrderStatusCard"]
    - path: "src/lib/lead-time.ts"
      provides: "Lead time calculation utilities"
      exports: ["calculateOrderByDate", "calculateExpectedArrival"]
  key_links:
    - from: "src/server/api/routers/tracking.ts"
      to: "src/server/db/schema.ts"
      via: "Drizzle queries on purchaseOrders, retailOrders, brands, skus, inventory"
      pattern: "purchaseOrders|retailOrders|brands"
    - from: "src/server/api/root.ts"
      to: "src/server/api/routers/tracking.ts"
      via: "Router registration"
      pattern: "tracking:\\s*trackingRouter"
    - from: "src/components/tracking/po-timeline.tsx"
      to: "date-fns"
      via: "Date formatting"
      pattern: "format.*date-fns"
    - from: "src/lib/lead-time.ts"
      to: "date-fns"
      via: "Date math"
      pattern: "addDays|subDays"
---

<objective>
Create the tracking tRPC router and shared UI components needed by all order tracking and role-based dashboard pages.

Purpose: This plan establishes the data access layer and reusable visual components that Plans 02 and 03 will consume. Without these, no tracking pages or role dashboards can render real data.

Output: tracking.ts tRPC router (registered in root), 4 UI components (status-badge, lead-time-badge, po-timeline, order-status-card), and lead time calculation utilities.
</objective>

<execution_context>
@/Users/kaaba/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kaaba/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-order-tracking-role-based-views/04-RESEARCH.md

@src/server/db/schema.ts
@src/server/api/root.ts
@src/server/api/routers/orders.ts
@src/server/api/trpc.ts
@src/components/dashboard/stat-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tracking tRPC router and lead time utilities</name>
  <files>
    src/server/api/routers/tracking.ts
    src/server/api/root.ts
    src/lib/lead-time.ts
  </files>
  <action>
    Create `src/lib/lead-time.ts` with two exported functions:
    - `calculateOrderByDate(needByDate: Date, leadTimeDays: number): Date` — returns `subDays(needByDate, leadTimeDays + 5)` (5-day buffer)
    - `calculateExpectedArrival(orderDate: Date, leadTimeDays: number): Date` — returns `addDays(orderDate, leadTimeDays)`
    Both use date-fns (already installed).

    Create `src/server/api/routers/tracking.ts` with these procedures:

    1. `supplierOrders` (protectedProcedure) — input: `{ brandId?: number, status?: string }`. Queries purchaseOrders joined with brands (to get brand name and leadTimeDays). Returns list with id, poNumber, supplier, status, orderDate, expectedArrival, actualArrival, totalAmount, currency, depositAmount, depositPaid, brand (id, name, leadTimeDays), createdAt. Ordered by orderDate DESC. Filter by brandId and status if provided.

    2. `supplierOrderDetail` (protectedProcedure) — input: `{ id: number }`. Returns single PO with all fields plus lineItems (joined with SKU names) and payments. Use Drizzle relational queries or manual joins.

    3. `retailOrders` (protectedProcedure) — input: `{ brandId?: number, retailerId?: number, status?: string }`. Queries retailOrders joined with brands and retailers. Returns id, retailerPoNumber, status, orderDate, shipByDate, totalAmount, brand (id, name), retailer (id, name), createdAt. Ordered by orderDate DESC.

    4. `retailOrderDetail` (protectedProcedure) — input: `{ id: number }`. Returns single retail order with lineItems (joined with SKU names) and payments.

    5. `leadTimeOverview` (protectedProcedure) — input: `{ brandId?: number }`. For each active PO (status NOT 'arrived', NOT 'cancelled'), calculate order-by date using brand.leadTimeDays and the PO's expectedArrival. Return PO info with computed orderByDate and daysUntilOrderBy. This uses the lead-time utility functions.

    6. `statusSummary` (protectedProcedure) — returns count of POs grouped by status, and count of retail orders grouped by status. Use SQL COUNT + GROUP BY via Drizzle sql template.

    Register the tracking router in `src/server/api/root.ts`: import trackingRouter and add `tracking: trackingRouter` to the router. Follow the exact pattern of existing router registrations.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compilation passes with no errors. Check that the tracking router exports are valid by confirming the root.ts file includes the tracking registration.
  </verify>
  <done>
    tracking.ts router exists with 6 procedures (supplierOrders, supplierOrderDetail, retailOrders, retailOrderDetail, leadTimeOverview, statusSummary). Root router registers tracking. lead-time.ts exports two calculation functions. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared tracking UI components</name>
  <files>
    src/components/tracking/status-badge.tsx
    src/components/tracking/lead-time-badge.tsx
    src/components/tracking/po-timeline.tsx
    src/components/tracking/order-status-card.tsx
  </files>
  <action>
    Create `src/components/tracking/` directory with 4 components:

    1. `status-badge.tsx` — "use client". Exports `StatusBadge({ status: string })`. Maps PO statuses (draft, ordered, confirmed, in_production, shipped, in_transit, arrived, cancelled) and retail statuses (received, processing, allocated, shipped, delivered) to shadcn Badge variants. Use 3-4 semantic colors only: "secondary" for draft/inactive, "default" for in-progress states (ordered, confirmed, in_production, shipped, in_transit, received, processing, allocated), "success" class (green) for terminal positive (arrived, delivered), "destructive" for cancelled. For the "success" variant which shadcn Badge doesn't have by default, use className="bg-green-100 text-green-800 hover:bg-green-100/80" on a secondary Badge. Fallback: unknown status renders as secondary with the raw status text.

    2. `lead-time-badge.tsx` — "use client". Exports `LeadTimeBadge({ orderByDate: Date })`. Uses date-fns differenceInDays and isPast. If overdue (past date): destructive badge "Overdue by N days". If urgent (<=7 days): amber badge with className="bg-amber-100 text-amber-800" showing "Order in N days". If normal: secondary badge "Order by in N days". Handle null orderByDate gracefully (show "N/A" secondary badge).

    3. `po-timeline.tsx` — "use client". Exports `POTimeline({ currentStatus, orderDate?, expectedArrival?, actualArrival? })`. Renders vertical timeline with 6 steps: ordered, confirmed, in_production, shipped, in_transit, arrived. Each step is a Card with icon (Check, CheckCircle, Clock, Package, Truck, Warehouse from lucide-react), label, date (if available), and completion state. Steps before currentStatus show green circle + "Complete" badge. Current step shows blue circle + "Current" badge. Future steps show gray circle. Handle null dates gracefully ("Not yet scheduled"). Use format() from date-fns for date display.

    4. `order-status-card.tsx` — "use client". Exports `OrderStatusCard({ title, counts: { status: string, count: number }[], total: number })`. Renders a shadcn Card showing a title, total count prominently, then a list of status-count pairs each using StatusBadge. Follow the stat-card.tsx pattern for visual consistency. Import and use StatusBadge from status-badge.tsx.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify all components compile. Verify imports resolve correctly (shadcn Badge, Card, lucide-react icons, date-fns).
  </verify>
  <done>
    Four tracking components exist in src/components/tracking/. StatusBadge handles 12 status values. LeadTimeBadge shows urgency colors. POTimeline renders 6-step lifecycle. OrderStatusCard shows counts by status. All compile without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. src/server/api/routers/tracking.ts exports trackingRouter
3. src/server/api/root.ts includes `tracking: trackingRouter`
4. src/lib/lead-time.ts exports calculateOrderByDate and calculateExpectedArrival
5. src/components/tracking/ contains 4 .tsx files
6. All components use "use client" directive
</verification>

<success_criteria>
- Tracking router registered and exposes 6 procedures for supplier orders, retail orders, lead times, and status summaries
- 4 reusable tracking components ready for consumption by tracking pages and role dashboards
- Lead time utility correctly computes order-by and arrival dates
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-order-tracking-role-based-views/04-01-SUMMARY.md`
</output>
