---
phase: 04-order-tracking-role-based-views
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/(dashboard)/roles/ceo/page.tsx
  - src/app/(dashboard)/roles/sales/page.tsx
  - src/app/(dashboard)/roles/purchasing/page.tsx
  - src/app/(dashboard)/roles/warehouse/page.tsx
  - src/components/dashboard/app-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "CEO dashboard shows overview with top alerts, demand health summary, and order pipeline status"
    - "Sales dashboard shows retailer order status, forecasts, and demand by retailer"
    - "Purchasing dashboard shows supply gaps, PO tracking status, and lead time alerts"
    - "Warehouse dashboard shows inbound shipments, current stock levels, and items needing allocation"
    - "Each role dashboard restricts access to users with matching role via server-side auth check"
    - "Sidebar navigation includes Tracking section and Role Views section with links to all new pages"
  artifacts:
    - path: "src/app/(dashboard)/roles/ceo/page.tsx"
      provides: "CEO overview dashboard"
      min_lines: 50
    - path: "src/app/(dashboard)/roles/sales/page.tsx"
      provides: "Sales team dashboard"
      min_lines: 50
    - path: "src/app/(dashboard)/roles/purchasing/page.tsx"
      provides: "Purchasing team dashboard"
      min_lines: 50
    - path: "src/app/(dashboard)/roles/warehouse/page.tsx"
      provides: "Warehouse team dashboard"
      min_lines: 50
    - path: "src/components/dashboard/app-sidebar.tsx"
      provides: "Updated sidebar with Tracking and Role Views sections"
      contains: "Tracking"
  key_links:
    - from: "src/app/(dashboard)/roles/ceo/page.tsx"
      to: "src/server/api/routers/alerts.ts"
      via: "tRPC query for shortage/excess alerts"
      pattern: "alerts\\."
    - from: "src/app/(dashboard)/roles/purchasing/page.tsx"
      to: "src/server/api/routers/tracking.ts"
      via: "tRPC query for supplier orders and lead times"
      pattern: "tracking\\.supplierOrders|tracking\\.leadTimeOverview"
    - from: "src/app/(dashboard)/roles/warehouse/page.tsx"
      to: "src/server/api/routers/tracking.ts"
      via: "tRPC query for inbound shipments"
      pattern: "tracking\\.supplierOrders"
    - from: "src/app/(dashboard)/roles/sales/page.tsx"
      to: "src/server/api/routers/demand.ts"
      via: "tRPC query for demand by retailer"
      pattern: "demand\\."
    - from: "src/components/dashboard/app-sidebar.tsx"
      to: "/tracking/ and /roles/ routes"
      via: "Navigation links"
      pattern: "tracking|roles"
---

<objective>
Build role-based dashboard views for each team member type (CEO, Sales, Purchasing, Warehouse) and update sidebar navigation to include tracking and role view sections.

Purpose: Satisfies UX-02 (role-based views). Each team member type sees a tailored dashboard showing exactly the information they need. CEO sees the big picture; Sales sees retailer status; Purchasing sees supply gaps and PO tracking; Warehouse sees inbound shipments and stock levels.

Output: 4 role-specific dashboard pages + updated sidebar navigation with Tracking and Role Views sections.
</objective>

<execution_context>
@/Users/kaaba/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kaaba/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-order-tracking-role-based-views/04-RESEARCH.md
@.planning/phases/04-order-tracking-role-based-views/04-01-SUMMARY.md

@src/server/auth.ts
@src/server/api/routers/tracking.ts
@src/server/api/routers/alerts.ts
@src/server/api/routers/demand.ts
@src/components/dashboard/app-sidebar.tsx
@src/components/dashboard/stat-card.tsx
@src/components/tracking/status-badge.tsx
@src/components/tracking/order-status-card.tsx
@src/app/(dashboard)/executive/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 4 role-based dashboard pages</name>
  <files>
    src/app/(dashboard)/roles/ceo/page.tsx
    src/app/(dashboard)/roles/sales/page.tsx
    src/app/(dashboard)/roles/purchasing/page.tsx
    src/app/(dashboard)/roles/warehouse/page.tsx
  </files>
  <action>
    Create 4 role-specific dashboard pages under `src/app/(dashboard)/roles/`. Each page is a Server Component that checks `session.user.role` via `auth()` from `@/server/auth` and redirects unauthorized users to "/". CEO role can access all pages. Each page follows the executive/page.tsx pattern for layout.

    **CEO Dashboard (`/roles/ceo/page.tsx`):**
    - Access: role === "ceo" (redirect others to "/")
    - Server Component shell that renders a client component for data fetching
    - Content sections (each in a Card):
      1. **Alerts Overview** — Uses alerts.shortages and alerts.excesses queries. Show count of shortage alerts (red), excess alerts (amber), and healthy SKUs (green) using StatCard components.
      2. **Order Pipeline** — Uses tracking.statusSummary. Shows OrderStatusCard for PO pipeline (how many in each status) and retail order pipeline.
      3. **Demand Health** — Uses demand.crossBrandSummary. Shows total forecasted vs ordered vs available across all brands in StatCard grid.
      4. **Quick Links** — Cards linking to /tracking/supplier-orders, /tracking/retail-orders, /demand, /executive.

    **Sales Dashboard (`/roles/sales/page.tsx`):**
    - Access: role === "sales" OR role === "ceo"
    - Content sections:
      1. **Retailer Order Status** — Uses tracking.retailOrders (no filters). Shows recent retail orders in a compact table (last 10) with StatusBadge. Link to full /tracking/retail-orders.
      2. **Demand by Retailer** — Uses demand.byRetailer. Shows top retailers by forecasted units in a summary card. Link to /demand/by-retailer.
      3. **Forecast Summary** — Uses demand.crossBrandSummary. Shows forecasted vs ordered totals per brand.

    **Purchasing Dashboard (`/roles/purchasing/page.tsx`):**
    - Access: role === "purchasing" OR role === "ceo"
    - Content sections:
      1. **Supply Gaps** — Uses alerts.shortages. Shows top shortage alerts (SKUs where demand > supply) in a compact table with StatusBadge. Red highlight for critical shortages.
      2. **PO Tracking** — Uses tracking.supplierOrders. Shows recent supplier POs (last 10) with status and deposit info. Link to full /tracking/supplier-orders.
      3. **Lead Time Alerts** — Uses tracking.leadTimeOverview. Shows POs with upcoming order-by dates using LeadTimeBadge. Sorted by urgency (overdue first, then soonest).

    **Warehouse Dashboard (`/roles/warehouse/page.tsx`):**
    - Access: role === "warehouse" OR role === "ceo"
    - Content sections:
      1. **Inbound Shipments** — Uses tracking.supplierOrders filtered to status "shipped" or "in_transit". Shows what's coming with expected arrival dates.
      2. **Stock Levels** — Uses demand.bySkuDrilldown or a dedicated query showing top SKUs by on-hand inventory with available/allocated/in-transit breakdown.
      3. **Allocation Needed** — Shows retail orders in "received" or "processing" status that need stock allocated. Uses tracking.retailOrders with status filter.

    All pages: Use consistent heading pattern (h1 with text-3xl font-bold, subtitle in text-muted-foreground). Use grid layout (grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6) for card sections. Handle loading states. Each page wraps data-fetching content in a "use client" child component since the parent Server Component handles auth.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify all 4 pages compile. Check that auth() import resolves and redirect import from next/navigation works.
  </verify>
  <done>
    Four role-based dashboards exist: CEO overview with alerts + pipeline + demand health; Sales with retailer status + forecasts; Purchasing with supply gaps + PO tracking + lead time alerts; Warehouse with inbound shipments + stock levels + allocation needs. Each page restricts access by role via server-side auth check.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update sidebar navigation with Tracking and Role Views</name>
  <files>
    src/components/dashboard/app-sidebar.tsx
  </files>
  <action>
    Update `src/components/dashboard/app-sidebar.tsx` to add two new navigation sections:

    1. **Tracking** section (insert between "Demand" and "Data" sections):
       - "Supplier Orders" -> /tracking/supplier-orders (icon: Truck)
       - "Retail Orders" -> /tracking/retail-orders (icon: ShoppingBag — reuse, or use ClipboardList)

    2. **Role Views** section (insert after "Orders" section, before "Master Data"):
       - "CEO Overview" -> /roles/ceo (icon: Crown or BarChart3)
       - "Sales View" -> /roles/sales (icon: TrendingUp — reuse, or use Users)
       - "Purchasing View" -> /roles/purchasing (icon: ShoppingCart — reuse, or use Clipboard)
       - "Warehouse View" -> /roles/warehouse (icon: Warehouse)

    Add necessary lucide-react icon imports at the top. Keep all existing sections intact. The navSections array order should be: Overview, Demand, Tracking, Data, Orders, Role Views, Master Data, System.

    Note: Use icons that are NOT already used in other sections to avoid visual confusion. Good choices from lucide-react: Truck (supplier shipping), ClipboardList (retail orders), BarChart3 (CEO), Users (sales), Clipboard (purchasing), Warehouse (warehouse). Verify these exist in lucide-react.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify compilation. Verify that the navSections array has 8 sections (Overview, Demand, Tracking, Data, Orders, Role Views, Master Data, System).
  </verify>
  <done>
    Sidebar shows 8 navigation sections. Tracking section links to /tracking/supplier-orders and /tracking/retail-orders. Role Views section links to /roles/ceo, /roles/sales, /roles/purchasing, /roles/warehouse. Active state highlighting works for all new routes.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. /roles/ceo accessible by CEO role, shows alerts + pipeline + demand health
3. /roles/sales accessible by Sales + CEO roles, shows retailer status + forecasts
4. /roles/purchasing accessible by Purchasing + CEO roles, shows supply gaps + PO tracking
5. /roles/warehouse accessible by Warehouse + CEO roles, shows inbound + stock + allocation
6. Non-matching roles redirected to "/" when accessing restricted role pages
7. Sidebar shows 8 sections with correct links and icons
</verification>

<success_criteria>
- Role-based views show appropriate information for each user type (UX-02)
- CEO: overview and alerts
- Sales: retailer status and forecasts
- Purchasing: supply gaps and PO tracking
- Warehouse: inbound shipments and stock levels
- Navigation updated to surface all new pages
- Access control enforced server-side
</success_criteria>

<output>
After completion, create `.planning/phases/04-order-tracking-role-based-views/04-03-SUMMARY.md`
</output>
